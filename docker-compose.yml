# ClawForge Multi-Instance Docker Compose
# Runs Noah's instance and StrategyES instance behind Traefik reverse proxy.
#
# Usage:
#   cp .env.example .env   # Fill in all values
#   docker compose up -d

networks:
  noah-net:
    driver: bridge
  strategyES-net:
    driver: bridge
  proxy-net:
    driver: bridge

services:
  # ─── Reverse Proxy ───────────────────────────────────────────────────
  traefik:
    image: traefik:v3
    networks:
      - proxy-net
      - noah-net
      - strategyES-net
    command:
      - --providers.docker=true
      - --providers.docker.exposedByDefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_certs:/letsencrypt
    restart: unless-stopped

  # ─── Noah's Event Handler ────────────────────────────────────────────
  noah-event-handler:
    container_name: clawforge-noah
    build:
      context: .
      dockerfile: instances/noah/Dockerfile
    networks:
      - noah-net
      - proxy-net
    environment:
      APP_URL: ${NOAH_APP_URL}
      APP_HOSTNAME: ${NOAH_APP_HOSTNAME}
      AUTH_SECRET: ${NOAH_AUTH_SECRET}
      AUTH_TRUST_HOST: "true"
      GH_TOKEN: ${NOAH_GH_TOKEN}
      GH_OWNER: ${NOAH_GH_OWNER}
      GH_REPO: ${NOAH_GH_REPO}
      GH_WEBHOOK_SECRET: ${NOAH_GH_WEBHOOK_SECRET}
      LLM_PROVIDER: ${NOAH_LLM_PROVIDER:-anthropic}
      LLM_MODEL: ${NOAH_LLM_MODEL:-claude-sonnet-4-6}
      ANTHROPIC_API_KEY: ${NOAH_ANTHROPIC_API_KEY}
      SLACK_BOT_TOKEN: ${NOAH_SLACK_BOT_TOKEN}
      SLACK_SIGNING_SECRET: ${NOAH_SLACK_SIGNING_SECRET}
      SLACK_ALLOWED_USERS: ${NOAH_SLACK_ALLOWED_USERS}
      SLACK_ALLOWED_CHANNELS: ${NOAH_SLACK_ALLOWED_CHANNELS}
      TELEGRAM_BOT_TOKEN: ${NOAH_TELEGRAM_BOT_TOKEN}
      TELEGRAM_WEBHOOK_SECRET: ${NOAH_TELEGRAM_WEBHOOK_SECRET}
      TELEGRAM_CHAT_ID: ${NOAH_TELEGRAM_CHAT_ID}
    volumes:
      - noah-data:/app/data
      - noah-config:/app/config
    labels:
      - traefik.enable=true
      - traefik.http.routers.noah.rule=Host(`${NOAH_APP_HOSTNAME}`)
      - traefik.http.routers.noah.entrypoints=websecure
      - traefik.http.routers.noah.tls.certresolver=letsencrypt
      - traefik.http.services.noah.loadbalancer.server.port=80
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # ─── StrategyES Event Handler ────────────────────────────────────────
  ses-event-handler:
    container_name: clawforge-ses
    build:
      context: .
      dockerfile: instances/strategyES/Dockerfile
    networks:
      - strategyES-net
      - proxy-net
    environment:
      APP_URL: ${SES_APP_URL}
      APP_HOSTNAME: ${SES_APP_HOSTNAME}
      AUTH_SECRET: ${SES_AUTH_SECRET}
      AUTH_TRUST_HOST: "true"
      GH_TOKEN: ${SES_GH_TOKEN}
      GH_OWNER: ${SES_GH_OWNER:-ScalingEngine}
      GH_REPO: ${SES_GH_REPO:-strategyes-lab}
      GH_WEBHOOK_SECRET: ${SES_GH_WEBHOOK_SECRET}
      LLM_PROVIDER: ${SES_LLM_PROVIDER:-anthropic}
      LLM_MODEL: ${SES_LLM_MODEL:-claude-sonnet-4-6}
      ANTHROPIC_API_KEY: ${SES_ANTHROPIC_API_KEY}
      SLACK_BOT_TOKEN: ${SES_SLACK_BOT_TOKEN}
      SLACK_SIGNING_SECRET: ${SES_SLACK_SIGNING_SECRET}
      SLACK_ALLOWED_USERS: ${SES_SLACK_ALLOWED_USERS}
      SLACK_ALLOWED_CHANNELS: ${SES_SLACK_ALLOWED_CHANNELS}
      SLACK_REQUIRE_MENTION: ${SES_SLACK_REQUIRE_MENTION:-false}
      OPENAI_API_KEY: ${SES_OPENAI_API_KEY}
    volumes:
      - ses-data:/app/data
      - ses-config:/app/config
    labels:
      - traefik.enable=true
      - traefik.http.routers.ses.rule=Host(`${SES_APP_HOSTNAME}`)
      - traefik.http.routers.ses.entrypoints=websecure
      - traefik.http.routers.ses.tls.certresolver=letsencrypt
      - traefik.http.services.ses.loadbalancer.server.port=80
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
    restart: unless-stopped


volumes:
  noah-data:
  noah-config:
  ses-data:
  ses-config:
  traefik_certs:
