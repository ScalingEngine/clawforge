---
phase: 11-notification-pipeline-db-schema
plan: "03"
type: execute
wave: 2
depends_on:
  - "11-01"
files_modified:
  - lib/tools/github.js
  - lib/ai/tools.js
autonomous: true
requirements:
  - NOTIF-04

must_haves:
  truths:
    - "get_job_status called with a completed cross-repo job_id returns the target repo PR URL from the DB"
    - "get_job_status for a running job still hits the GitHub Actions API (live path unchanged)"
    - "Agent description for get_job_status tool mentions it can return completed job outcomes including target_repo"
  artifacts:
    - path: "lib/tools/github.js"
      provides: "getJobStatus() with DB overlay path for completed jobs"
      contains: "jobOutcomes"
    - path: "lib/ai/tools.js"
      provides: "getJobStatusTool with updated description mentioning cross-repo PR URL"
      contains: "completed job"
  key_links:
    - from: "lib/tools/github.js getJobStatus()"
      to: "lib/db/schema.js jobOutcomes"
      via: "getDb().select().from(jobOutcomes).where(eq(jobOutcomes.jobId, jobId)).get()"
      pattern: "from\\(jobOutcomes\\)"
    - from: "lib/tools/github.js getJobStatus()"
      to: "lib/db/index.js getDb()"
      via: "import { getDb } from '../db/index.js'"
      pattern: "getDb\\(\\)"
---

<objective>
Extend getJobStatus() in lib/tools/github.js to overlay completed job outcomes from SQLite when a specific job_id is requested but not found in live GitHub Actions runs. Update the get_job_status tool description in lib/ai/tools.js to reflect this capability.

Purpose: When a user asks "what happened with job X?" after it completes, the agent can now report the outcome including the target repo PR URL — currently getJobStatus() only covers live/running jobs and returns nothing for completed ones.
Output: Updated getJobStatus() with DB fallback path; updated tool description.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-notification-pipeline-db-schema/11-RESEARCH.md
@.planning/phases/11-notification-pipeline-db-schema/11-01-SUMMARY.md
@lib/tools/github.js
@lib/ai/tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DB overlay path to getJobStatus() for completed jobs</name>
  <files>lib/tools/github.js</files>
  <action>
    In lib/tools/github.js, make the following changes:

    **Step 1 — Add imports at top of file** (after existing code, before the first function):
    ```javascript
    import { getDb } from '../db/index.js';
    import { jobOutcomes } from '../db/schema.js';
    import { eq, desc } from 'drizzle-orm';
    ```

    Note: `desc` is already available from drizzle-orm but not currently imported in this file. `eq` is also not currently imported. Confirm the imports are additive — do not duplicate if any happen to already be present.

    **Step 2 — Add DB overlay block inside getJobStatus()** after the existing `const jobs = await Promise.all(...)` block and after the runningCount/queuedCount computation, but BEFORE the final `return { jobs, queued, running }` statement:

    ```javascript
    // DB overlay: if a specific job_id was requested and not found in live runs,
    // look up completed outcome from job_outcomes table (NOTIF-04)
    if (jobId && filteredRuns.length === 0) {
      try {
        const db = getDb();
        const outcome = db
          .select()
          .from(jobOutcomes)
          .where(eq(jobOutcomes.jobId, jobId))
          .orderBy(desc(jobOutcomes.createdAt))
          .limit(1)
          .get();

        if (outcome) {
          return {
            jobs: [
              {
                job_id: jobId,
                status: 'completed',
                outcome_status: outcome.status,
                pr_url: outcome.prUrl,
                target_repo: outcome.targetRepo || null,
                log_summary: outcome.logSummary,
              },
            ],
            queued: 0,
            running: 0,
          };
        }
      } catch (err) {
        // Non-fatal: DB errors should not break live job status reporting
        console.error('Failed to look up completed job outcome:', err);
      }
    }
    ```

    CIRCULAR DEPENDENCY CHECK: lib/tools/github.js importing from lib/db/index.js is SAFE. lib/db/index.js imports only from lib/paths.js and lib/db/schema.js — it does NOT import from lib/tools/. No circular dependency.

    The existing live GitHub Actions API path is completely unchanged. This overlay only fires when: (1) a specific job_id was provided AND (2) that job_id is not found in live/queued runs.
  </action>
  <verify>
    <automated>grep -n "getDb\|jobOutcomes\|outcome_status\|target_repo" "/Users/nwessel/Claude Code/Business/Products/clawforge/lib/tools/github.js"</automated>
    <manual>Confirm DB overlay block exists after jobs array computation and before final return; confirm imports are at top of file</manual>
  </verify>
  <done>lib/tools/github.js imports getDb, jobOutcomes, eq, desc; getJobStatus() has DB overlay block that fires when jobId provided but not found in live runs; returns { jobs: [{ job_id, status: 'completed', outcome_status, pr_url, target_repo, log_summary }], queued: 0, running: 0 } when outcome found</done>
</task>

<task type="auto">
  <name>Task 2: Update get_job_status tool description to reflect completed job capability</name>
  <files>lib/ai/tools.js</files>
  <action>
    In lib/ai/tools.js, update the getJobStatusTool description string to inform the agent that it can also retrieve completed job outcomes:

    Replace the current description:
    ```javascript
    description:
      'Check status of running jobs. Returns list of active workflow runs with timing and current step. Use when user asks about job progress, running jobs, or job status.',
    ```

    With:
    ```javascript
    description:
      'Check status of running jobs or look up completed job outcomes. For live jobs, returns active workflow runs with timing and current step. For completed jobs (when a job_id is provided), returns the outcome including PR URL and target repo if applicable. Use when user asks about job progress, running jobs, job status, or what happened with a specific job.',
    ```

    No other changes to lib/ai/tools.js are needed. The tool schema (job_id optional string) is already correct.
  </action>
  <verify>
    <automated>grep -n "description" "/Users/nwessel/Claude Code/Business/Products/clawforge/lib/ai/tools.js" | grep -i "completed\|outcome"</automated>
    <manual>Confirm getJobStatusTool description now mentions completed jobs and PR URL</manual>
  </verify>
  <done>lib/ai/tools.js getJobStatusTool description includes "completed job outcomes", "PR URL", and "target repo" language so the agent knows to use this tool for post-completion job lookups</done>
</task>

</tasks>

<verification>
1. lib/tools/github.js has three new imports: getDb, jobOutcomes, eq (or confirms desc was already imported)
2. getJobStatus() DB overlay block fires only when: jobId truthy AND filteredRuns.length === 0
3. DB overlay return shape matches existing job entry shape with additional outcome_status, pr_url, target_repo fields
4. DB overlay wrapped in try/catch — DB errors are non-fatal and logged
5. Live job status path is unchanged — same flow for jobId=null or jobId found in live runs
6. lib/ai/tools.js getJobStatusTool description updated to mention completed job outcomes
</verification>

<success_criteria>
- getJobStatus(someCompletedJobId) with no live run match returns { jobs: [{ job_id, status: 'completed', outcome_status, pr_url, target_repo, log_summary }], queued: 0, running: 0 }
- getJobStatus() with no jobId (list all) still hits only the GitHub Actions API
- getJobStatus(liveJobId) where a live run exists still returns the live run data
- Tool description guides agent to use get_job_status for historical lookups not just live runs
</success_criteria>

<output>
After completion, create `.planning/phases/11-notification-pipeline-db-schema/11-03-SUMMARY.md`
</output>
