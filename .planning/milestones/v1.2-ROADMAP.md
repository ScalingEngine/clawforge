# Milestone v1.2: Cross-Repo Job Targeting

**Status:** ✅ SHIPPED 2026-02-27
**Phases:** 9-12
**Total Plans:** 10 (v1.2); 23 cumulative
**Files changed:** 46 (+5,605 / -93)
**Timeline:** 2 days (2026-02-25 → 2026-02-26)

## Overview

Enabled ClawForge job containers to clone and operate on any allowed target repo, not just the clawforge repo itself. The agent selects the target repo from natural language, the container performs a two-phase clone, PRs are created on the target repo with correct branch naming and attribution, and notifications include the correct target repo PR URL. All existing same-repo job behavior is preserved.

## Phases

### Phase 9: Config Layer + Tool Schema + Entrypoint Foundation

**Goal:** target_repo travels through the full system — from agent tool call through job creation — and the entrypoint operates correctly for all jobs regardless of target
**Depends on:** Phase 8 (v1.1 complete)
**Requirements:** CFG-01, CFG-02, TOOL-01, TOOL-02, TOOL-03, EXEC-02, EXEC-04
**Plans:** 3 plans

Plans:
- [x] 09-01: REPOS.json config, repos.js resolver, Dockerfile COPY, PAT docs
- [x] 09-02: Job image /defaults/ SOUL/AGENT bake, entrypoint fallback, EXEC-04 audit
- [x] 09-03: create_job target_repo schema + validation, target.json sidecar write

**Details:**
Success criteria verified:
1. Agent accepts "work on [repo name]" and resolves it to a valid allowed repo slug (or rejects if not allowed)
2. A job created with a target repo writes target.json alongside job.md on the clawforge job branch
3. Jobs created without a target repo produce no target.json and behave identically to v1.1
4. SOUL.md and AGENT.md are loaded from the Docker image for all jobs
5. No PAT appears in any clone URL (gh auth setup-git handles all auth)

---

### Phase 10: Actions Workflow + Container Execution + Cross-Repo PR

**Goal:** Container reads target.json, clones the target repo as its working tree, and creates a PR on the target repo with correct branch naming and default branch detection
**Depends on:** Phase 9
**Requirements:** PR-01, EXEC-01, EXEC-03, PR-02, PR-03, PR-04, PR-05
**Plans:** 3 plans

Plans:
- [x] 10-01: Two-phase clone with WORK_DIR routing, clone-error.md failure guard, cross-repo FULL_PROMPT context
- [x] 10-02: Cross-repo branch creation, default branch detection, gh pr create --repo, pr-result.json + pr-error.md sidecars
- [x] 10-03: notify-pr-complete.yml push trigger extension for cross-repo PR completion notification

**Details:**
Success criteria verified:
1. Cross-repo job causes Claude to operate on target repo's codebase, not clawforge's
2. PR appears in the target repo with branch name clawforge/{uuid}
3. PR base branch matches target repo's actual default branch (not hardcoded to main)
4. Clone failure writes clone-error.md; failure stage surfaces as "clone" in notification
5. PR body identifies ClawForge as originating system with job ID

---

### Phase 11: Notification Pipeline + DB Schema

**Goal:** Cross-repo job completions reach the user via Slack/Telegram with the correct target repo PR URL, and outcomes are recorded with target repo attribution
**Depends on:** Phase 10
**Requirements:** NOTIF-01, NOTIF-02, NOTIF-03, NOTIF-04
**Plans:** 3 plans

Plans:
- [x] 11-01: DB schema target_repo column + Drizzle migration + saveJobOutcome() update
- [x] 11-02: Webhook handler target_repo passthrough + Telegram thread-origin routing
- [x] 11-03: getJobStatus() DB overlay for completed jobs + tool description update

**Details:**
Success criteria verified:
1. Cross-repo job completion triggers Slack/Telegram notification with target repo PR URL
2. Notification message distinguishes "PR open for review" (cross-repo) from "merged" (same-repo)
3. job_outcomes table records target repo, visible via get_job_status
4. Same-repo job notifications unaffected

---

### Phase 12: Regression Verification

**Goal:** Both instances confirmed working end-to-end for both same-repo and cross-repo jobs, with no silent failures
**Depends on:** Phase 11
**Requirements:** REG-01, REG-02
**Plans:** 1 plan

Plans:
- [x] 12-01: Write VERIFICATION-RUNBOOK.md with 5 end-to-end scenarios (S1-S5) covering both instances

**Details:**
Deliverable: `VERIFICATION-RUNBOOK.md` — operator-executable checklist for all 5 v1.2 regression scenarios. Pass gate: all 5 scenarios PASS required before v1.2 ships.

---

## Milestone Summary

**Key Decisions:**

- Cross-repo notification fires from entrypoint directly — notify-pr-complete.yml cannot observe events in foreign repos
- SOUL.md/AGENT.md baked into Docker image (/defaults/) — cross-repo working tree has no ClawForge config
- gh auth setup-git for all clones — PAT never interpolated into clone URLs (Actions log exposure risk)
- Job branches always live in clawforge — on:create trigger constraint; target.json sidecar carries target metadata
- Cross-repo PRs notify at PR creation, same-repo at merge — semantic difference surfaces in UX language
- WORK_DIR defaults to /job; set to /workspace only when target.json detected — 100% backward compat
- clone-error.md committed to clawforge job branch before exit 1 — Phase 11 failure detection reads it there
- DB overlay fires only when jobId provided AND filteredRuns.length === 0 — live path fully unchanged
- Runbook stops at checkpoint:human-verify — operator must confirm completeness before live testing

**Issues Resolved:**

- Cross-repo jobs broken since initial design: Claude operated on clawforge working tree instead of target repo (root cause fixed in Phase 10)
- get_job_status returning nothing for completed jobs (fixed in Phase 11 DB overlay)

**Issues Deferred:**

- Live end-to-end test runs (S1-S5 in VERIFICATION-RUNBOOK.md) — operator action, not code
- StrategyES REPOS.json operator confirmation — pre-ship operator task

**Technical Debt Incurred:**

- No caching in loadAllowedRepos() — reads file on every call (acceptable: <1KB, changes require rebuild anyway)

---

*For current project status, see .planning/PROJECT.md*
