---
phase: 14-intake-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - instances/noah/config/EVENT_HANDLER.md
autonomous: true
requirements:
  - INTAKE-02
  - INTAKE-03
  - INTAKE-04
  - INTAKE-05

must_haves:
  truths:
    - "Archie begins multi-turn intake when operator signals instance creation intent"
    - "Required fields (name, purpose, allowed_repos, enabled_channels) are collected across no more than 4 grouped turns"
    - "Optional fields (slack_user_ids, telegram_chat_id) are captured silently if volunteered — no dedicated question asked"
    - "Archie always presents a configuration summary and waits for explicit approval before calling create_instance_job"
    - "Operator saying cancel/never mind at any point resets intake without leaving partial state"
    - "Intake protocol explicitly overrides the bias-toward-action rule so Archie does not dispatch immediately on intent signal"
  artifacts:
    - path: "instances/noah/config/EVENT_HANDLER.md"
      provides: "Instance Creation Intake section with slot-filling protocol, approval gate, and cancellation handling"
      contains: "Instance Creation Intake"
    - path: "instances/noah/config/EVENT_HANDLER.md"
      provides: "Explicit override of bias-toward-action for instance creation"
      contains: "Do not apply the bias-toward-action rule"
    - path: "instances/noah/config/EVENT_HANDLER.md"
      provides: "Exact tool name reference matching Phase 13 registration"
      contains: "create_instance_job"
  key_links:
    - from: "instances/noah/config/EVENT_HANDLER.md"
      to: "lib/ai/agent.js"
      via: "render_md(eventHandlerMd) injected as system message every invocation"
      pattern: "render_md.*eventHandlerMd"
    - from: "instances/noah/config/EVENT_HANDLER.md"
      to: "lib/ai/tools.js create_instance_job"
      via: "LLM calls tool by exact snake_case name after approval gate"
      pattern: "create_instance_job"
---

<objective>
Add the "Instance Creation Intake" section to Archie's system prompt, teaching multi-turn slot filling for instance configuration with approval gate and cancellation handling.

Purpose: Phase 13 registered the create_instance_job tool — the LLM now needs instructions on when and how to call it. This section defines the complete intake protocol: intent recognition, grouped question turns (max 4), silent optional-field capture, a mandatory approval gate before dispatch, and clean cancellation reset.

Output: instances/noah/config/EVENT_HANDLER.md with a new "Instance Creation Intake" section appended before the `{{datetime}}` line.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-intake-flow/14-RESEARCH.md
@instances/noah/config/EVENT_HANDLER.md
@.planning/phases/13-tool-infrastructure/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Instance Creation Intake section to EVENT_HANDLER.md</name>
  <files>instances/noah/config/EVENT_HANDLER.md</files>
  <action>
Append a new "Instance Creation Intake" section to `instances/noah/config/EVENT_HANDLER.md`. Insert it immediately before the final `Current datetime: {{datetime}}` line (preserving that line as the last content). Add a horizontal rule separator (`---`) before the section header to match the existing section separator pattern in the file.

The section must cover all four requirements. Write it exactly as follows (adapt formatting to match the file's existing Markdown style):

---

## Instance Creation Intake

When an operator signals intent to create a new ClawForge instance (e.g., "create an instance for Jim", "set up a new agent", "I want a new instance", "add an instance"), follow this intake protocol exactly.

**Do not apply the bias-toward-action rule here — instance creation always requires multi-turn collection before dispatch.**

### Required Fields

Collect ALL of these before calling `create_instance_job`:

| Field | Description | Example |
|-------|-------------|---------|
| `name` | Instance slug — lowercase, no spaces | `jim`, `acmecorp` |
| `purpose` | What this instance is for (used to write SOUL.md and AGENT.md) | "StrategyES dev agent restricted to Jim's workspace" |
| `allowed_repos` | GitHub repo slugs this instance can target (list) | `["strategyes-lab"]` |
| `enabled_channels` | Communication channels to enable: `slack`, `telegram`, `web` | `["slack"]` |

### Optional Fields — Capture Silently, Do NOT Ask

If the operator mentions either of these at any point during intake, capture it. Do NOT ask a dedicated question for either field. Only include them if volunteered.

- `slack_user_ids` — one or more Slack user IDs (format: `U0XXXXXXXXX`). Example: if operator says "Jim's Slack is U0ABC123", capture `U0ABC123`.
- `telegram_chat_id` — a Telegram chat ID (numeric). Example: if operator says "chat ID is 123456789", capture `123456789`.

### Turn Grouping (max 4 turns)

Group questions to minimize turns. Do not ask one field per turn.

- **Turn 1:** Ask for both `name` and `purpose` together
- **Turn 2:** Ask for `allowed_repos`
- **Turn 3:** Ask for `enabled_channels`
- **Turn 4 (only if needed):** Clarify any missing or ambiguous field

If the operator provides multiple fields in their opening message, skip those questions and only ask for what is still missing. Adjust turn count accordingly — a fully-specified opening message needs zero additional turns before the approval gate.

### Approval Gate (MANDATORY)

Before calling `create_instance_job`:

1. Present a complete configuration summary listing all collected fields
2. Wait for explicit approval: "yes", "confirmed", "go ahead", "do it", "lgtm", "looks good", "sounds good", or similar affirmative
3. **Only then** call `create_instance_job` with the exact approved configuration

**ALWAYS present the complete summary before dispatching, even if the operator says "yes" or "go ahead" before you have shown it.**

Example summary format:
```
Here's the instance configuration I'll use to create the job:

- **Name:** jim
- **Purpose:** StrategyES dev agent scoped to Jim's workspace
- **Allowed repos:** strategyes-lab
- **Channels:** slack
- **Slack user IDs:** U0XXXXXXXXX

Confirm with "yes" to dispatch the job, or tell me what to change.
```

### Cancellation

If the operator says "cancel", "never mind", "stop", "abort", or equivalent at any point during intake:

1. Acknowledge the cancellation clearly
2. Discard all collected instance configuration from this intake session
3. Confirm to the operator that the intake has been reset
4. Treat the next message as if no instance creation intake was in progress

Do NOT reference or use any configuration values from a cancelled intake in subsequent messages.

---

Key implementation notes for the action:
- The file currently ends with `---\n\nCurrent datetime: {{datetime}}\n`. Insert the new section between the last `---` separator and the `Current datetime` line.
- The tool name `create_instance_job` must be referenced exactly in snake_case — this matches the Phase 13 registration in lib/ai/tools.js. Do NOT use camelCase.
- Do NOT edit `config/EVENT_HANDLER.md` — that path is overwritten by Docker build. The source of truth is `instances/noah/config/EVENT_HANDLER.md`.
  </action>
  <verify>
    <automated>grep -c "Instance Creation Intake" "/Users/nwessel/Claude Code/Business/Products/clawforge/instances/noah/config/EVENT_HANDLER.md" && grep -c "create_instance_job" "/Users/nwessel/Claude Code/Business/Products/clawforge/instances/noah/config/EVENT_HANDLER.md" && grep -c "bias-toward-action rule here" "/Users/nwessel/Claude Code/Business/Products/clawforge/instances/noah/config/EVENT_HANDLER.md" && grep -c "Approval Gate" "/Users/nwessel/Claude Code/Business/Products/clawforge/instances/noah/config/EVENT_HANDLER.md" && grep -c "Cancellation" "/Users/nwessel/Claude Code/Business/Products/clawforge/instances/noah/config/EVENT_HANDLER.md" && grep -c "Do NOT ask a dedicated question" "/Users/nwessel/Claude Code/Business/Products/clawforge/instances/noah/config/EVENT_HANDLER.md" && tail -3 "/Users/nwessel/Claude Code/Business/Products/clawforge/instances/noah/config/EVENT_HANDLER.md"</automated>
    <manual>Verify the file ends with `Current datetime: {{datetime}}` as the last line and the new section appears before it. Confirm `config/EVENT_HANDLER.md` was NOT modified (only the instances/ source).</manual>
  </verify>
  <done>
    - instances/noah/config/EVENT_HANDLER.md contains "Instance Creation Intake" section
    - Section includes: required fields table, optional fields with "Do NOT ask" instruction, turn grouping (max 4), approval gate with summary format, cancellation reset protocol
    - File contains "create_instance_job" in snake_case (tool name matches Phase 13 registration)
    - Bias-toward-action override is explicit in the section header
    - File still ends with `Current datetime: {{datetime}}` as last line
    - config/EVENT_HANDLER.md was not modified
  </done>
</task>

</tasks>

<verification>
1. `grep -c "Instance Creation Intake" instances/noah/config/EVENT_HANDLER.md` returns 1
2. `grep -c "create_instance_job" instances/noah/config/EVENT_HANDLER.md` returns >= 2 (section header reference + approval gate)
3. `grep "Do not apply the bias-toward-action" instances/noah/config/EVENT_HANDLER.md` returns a match
4. `tail -5 instances/noah/config/EVENT_HANDLER.md` shows `Current datetime: {{datetime}}` as last line
5. `config/EVENT_HANDLER.md` diff shows no changes (only instances/ source was modified)
</verification>

<success_criteria>
- instances/noah/config/EVENT_HANDLER.md contains the complete Instance Creation Intake section
- All 4 intake requirements (INTAKE-02 through INTAKE-05) are addressed by explicit instructions in the section
- Tool name matches Phase 13 registration exactly (snake_case: create_instance_job)
- Bias-toward-action override is present and unambiguous
- Optional-field capture uses "Do NOT ask a dedicated question" language
- Cancellation instructions use strong, explicit language per RESEARCH.md pitfall guidance
- Approval gate requires presenting summary ALWAYS, even before affirmative signals
</success_criteria>

<output>
After completion, create `.planning/phases/14-intake-flow/14-01-SUMMARY.md`
</output>
