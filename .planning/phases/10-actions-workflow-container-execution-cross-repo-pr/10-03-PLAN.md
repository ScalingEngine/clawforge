---
phase: 10-actions-workflow-container-execution-cross-repo-pr
plan: "03"
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/.github/workflows/notify-pr-complete.yml
autonomous: true
requirements:
  - PR-01
  - PR-02
  - PR-03
  - PR-04
  - PR-05

must_haves:
  truths:
    - "When pr-result.json is pushed to a job/* branch, notify-pr-complete.yml fires and sends the cross-repo PR URL to the Event Handler"
    - "When a job/* branch push does NOT contain pr-result.json, the workflow fires but exits early (no notification sent)"
    - "The existing workflow_run trigger (same-repo auto-merge path) is preserved and unaffected"
    - "The cross-repo notification payload includes pr_url, target_repo, job_id, and job description"
  artifacts:
    - path: "templates/.github/workflows/notify-pr-complete.yml"
      provides: "push trigger on job/** branches for cross-repo completion detection"
      contains: "job/**"
    - path: "templates/.github/workflows/notify-pr-complete.yml"
      provides: "pr-result.json detection step with early-exit guard"
      contains: "pr-result.json"
  key_links:
    - from: "templates/docker/job/entrypoint.sh"
      to: "templates/.github/workflows/notify-pr-complete.yml"
      via: "push to job/* branch with pr-result.json triggers on:push"
      pattern: "pr-result\\.json"
    - from: "templates/.github/workflows/notify-pr-complete.yml"
      to: "Event Handler /api/github/webhook"
      via: "curl POST with pr_url and target_repo from pr-result.json"
      pattern: "pr_url"
---

<objective>
Extend notify-pr-complete.yml to handle the cross-repo completion path. Add an `on: push` trigger for `job/**` branches. In the notify job, detect which trigger fired: if triggered by push (cross-repo path), check for pr-result.json on the job branch — if present, send the cross-repo notification payload; if absent, exit 0 silently. If triggered by workflow_run (same-repo path), execute the existing notification logic unchanged.

Purpose: Cross-repo jobs cannot use the workflow_run/auto-merge trigger because the PR lives on a different repo (no auto-merge.yml fires there). The push to the clawforge job branch with pr-result.json is the only observable event in clawforge's own Actions when a cross-repo PR is created. This plan wires that event to the notification pipeline.

Output: Updated notify-pr-complete.yml with dual-trigger support, cross-repo path detection, and preserved same-repo path.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-actions-workflow-container-execution-cross-repo-pr/10-CONTEXT.md
@.planning/phases/10-actions-workflow-container-execution-cross-repo-pr/10-RESEARCH.md
@templates/.github/workflows/notify-pr-complete.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add push trigger on job/** branches to notify-pr-complete.yml</name>
  <files>templates/.github/workflows/notify-pr-complete.yml</files>
  <action>
Modify the `on:` section of `templates/.github/workflows/notify-pr-complete.yml` to add a push trigger for `job/**` branches alongside the existing `workflow_run` trigger.

**Current `on:` block:**
```yaml
on:
  workflow_run:
    workflows: ["Auto-Merge ClawForge PR"]
    types: [completed]
```

**Replace with:**
```yaml
on:
  workflow_run:
    workflows: ["Auto-Merge ClawForge PR"]
    types: [completed]
  push:
    branches:
      - 'job/**'
```

Also update the `if:` condition on the `notify` job to allow both trigger paths. The current condition only passes for workflow_run events:

**Current:**
```yaml
if: startsWith(github.event.workflow_run.head_branch, 'job/')
```

**Replace with:**
```yaml
if: startsWith(github.event.workflow_run.head_branch, 'job/') || startsWith(github.ref_name, 'job/')
```

This lets the job run for both the workflow_run path (same-repo auto-merge) and the push path (cross-repo pr-result.json). The distinction is handled inside the steps.

Add `contents: read` permissions if not already present (needed for `actions/checkout` on push-triggered runs). The existing permissions block already has `contents: read` — confirm and leave unchanged.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep -n "push:" templates/.github/workflows/notify-pr-complete.yml && grep -n "job/\*\*" templates/.github/workflows/notify-pr-complete.yml && grep -n "ref_name" templates/.github/workflows/notify-pr-complete.yml && python3 -c "import yaml; yaml.safe_load(open('templates/.github/workflows/notify-pr-complete.yml'))" && echo "YAML OK"</automated>
    <manual>Confirm: (1) on: block has both workflow_run and push triggers; (2) push trigger has branches: ['job/**']; (3) notify job if: condition checks both github.event.workflow_run.head_branch and github.ref_name</manual>
  </verify>
  <done>
    - `on: push: branches: ['job/**']` present in notify-pr-complete.yml
    - `workflow_run` trigger preserved unchanged
    - `notify` job `if:` condition checks both trigger paths
    - YAML parses without error (python3 -c "import yaml; yaml.safe_load(...)")
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cross-repo detection step with pr-result.json read and dual-path notification</name>
  <files>templates/.github/workflows/notify-pr-complete.yml</files>
  <action>
Add a new step in the `notify` job that detects which trigger path fired and handles both cases. Insert this as the FIRST step in the job, before the existing "Get PR number" step.

**New step — "Checkout job branch (cross-repo path)":**

The existing `actions/checkout` step (currently used after "Get PR number") checks out `${{ github.event.workflow_run.head_sha }}`. For the push path, we need to check out the pushed branch's HEAD. Add a checkout step that handles both:

```yaml
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'push' && github.sha || github.event.workflow_run.head_sha }}
```

Replace the existing standalone `Checkout PR branch` step with this unified version. (The existing step `uses: actions/checkout@v4` with `ref: ${{ github.event.workflow_run.head_sha }}` is incompatible with the push trigger since `github.event.workflow_run` is empty on push events.)

**New step — "Detect trigger path and route notification":**

Add immediately after the checkout step, before the existing "Get PR number" step:

```yaml
      - name: Detect trigger path
        id: route
        run: |
          EVENT="${{ github.event_name }}"

          if [ "$EVENT" = "push" ]; then
            # Cross-repo path: check for pr-result.json on this job branch
            BRANCH="${{ github.ref_name }}"
            JOB_ID="${BRANCH#job/}"

            if [ -f "logs/${JOB_ID}/pr-result.json" ]; then
              PR_URL=$(jq -r '.pr_url' "logs/${JOB_ID}/pr-result.json")
              TARGET_REPO=$(jq -r '.target_repo' "logs/${JOB_ID}/pr-result.json")
              PR_NUMBER=$(jq -r '.pr_number' "logs/${JOB_ID}/pr-result.json")
              echo "path=cross_repo" >> "$GITHUB_OUTPUT"
              echo "pr_url=${PR_URL}" >> "$GITHUB_OUTPUT"
              echo "target_repo=${TARGET_REPO}" >> "$GITHUB_OUTPUT"
              echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
              echo "job_id=${JOB_ID}" >> "$GITHUB_OUTPUT"
              echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
              echo "Cross-repo PR detected: ${PR_URL}"
            else
              # Push without pr-result.json (e.g., initial job.md commit) — skip silently
              echo "path=skip" >> "$GITHUB_OUTPUT"
              echo "No pr-result.json found on ${BRANCH} — skipping notification"
            fi
          else
            # Same-repo path (workflow_run from auto-merge)
            echo "path=same_repo" >> "$GITHUB_OUTPUT"
          fi
```

**Guard all existing steps with same-repo path condition:**

Add `if: steps.route.outputs.path == 'same_repo'` to the existing steps:
- "Get PR number" step
- "Gather job results and notify" step

**Add new cross-repo notification step after existing steps:**

```yaml
      - name: Notify cross-repo PR complete
        if: steps.route.outputs.path == 'cross_repo'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          JOB_ID="${{ steps.route.outputs.job_id }}"
          BRANCH="${{ steps.route.outputs.branch }}"
          PR_URL="${{ steps.route.outputs.pr_url }}"
          TARGET_REPO="${{ steps.route.outputs.target_repo }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Read job description from checked-out branch
          JOB_CONTENT=""
          if [ -f "logs/${JOB_ID}/job.md" ]; then
            JOB_CONTENT=$(cat "logs/${JOB_ID}/job.md")
          fi

          # Read GSD invocation log
          LOG_CONTENT=""
          LOG_DIR="logs/${JOB_ID}"
          if [ -d "$LOG_DIR" ]; then
            LOG_FILE=$(find "$LOG_DIR" -name "gsd-invocations.jsonl" -type f | head -1)
            if [ -n "$LOG_FILE" ]; then
              LOG_CONTENT=$(cat "$LOG_FILE")
            fi
          fi

          # Build cross-repo notification payload
          jq -n \
            --arg job_id "$JOB_ID" \
            --arg branch "$BRANCH" \
            --arg status "cross_repo_pr_open" \
            --arg job "$JOB_CONTENT" \
            --arg run_url "$RUN_URL" \
            --arg pr_url "$PR_URL" \
            --arg target_repo "$TARGET_REPO" \
            --arg log "$LOG_CONTENT" \
            --arg merge_result "cross_repo_pr_open" \
            '{
              job_id: $job_id,
              branch: $branch,
              status: $status,
              job: $job,
              run_url: $run_url,
              pr_url: $pr_url,
              target_repo: $target_repo,
              changed_files: [],
              commit_message: "",
              log: $log,
              merge_result: $merge_result
            }' > "${RUNNER_TEMP:-/tmp}/payload.json"

          # Send to event handler
          curl -s -X POST "${{ vars.APP_URL }}/api/github/webhook" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Webhook-Secret-Token: ${{ secrets.GH_WEBHOOK_SECRET }}" \
            -d @"${RUNNER_TEMP:-/tmp}/payload.json"
```

**Note on pitfall avoidance:** The early `exit 0` when `path=skip` is handled by the `if: steps.route.outputs.path == 'cross_repo'` condition, not by explicit exit. Workflow steps that don't match their `if:` condition are skipped, not failed — this is the correct pattern.

**Preserve same-repo steps exactly:** The existing "Get PR number" and "Gather job results and notify" steps must only get an `if: steps.route.outputs.path == 'same_repo'` condition added — no other changes to their bodies.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep -n "pr-result.json" templates/.github/workflows/notify-pr-complete.yml && grep -n "cross_repo" templates/.github/workflows/notify-pr-complete.yml && grep -n "path=skip\|path=same_repo\|path=cross_repo" templates/.github/workflows/notify-pr-complete.yml && python3 -c "import yaml; yaml.safe_load(open('templates/.github/workflows/notify-pr-complete.yml'))" && echo "YAML OK"</automated>
    <manual>Confirm: (1) detect-trigger step sets path=cross_repo/same_repo/skip; (2) cross-repo step gated by if: steps.route.outputs.path == 'cross_repo'; (3) existing Get PR number and Gather steps gated by if: steps.route.outputs.path == 'same_repo'; (4) YAML parses without error; (5) cross-repo payload includes pr_url, target_repo, status: cross_repo_pr_open</manual>
  </verify>
  <done>
    - "Detect trigger path" step exists with route outputs: path, pr_url, target_repo, pr_number, job_id, branch
    - "Notify cross-repo PR complete" step exists gated by `steps.route.outputs.path == 'cross_repo'`
    - Existing "Get PR number" and "Gather job results and notify" steps gated by `steps.route.outputs.path == 'same_repo'`
    - Unified checkout step handles both push (github.sha) and workflow_run (head_sha) refs
    - Cross-repo payload includes: job_id, branch, status=cross_repo_pr_open, job, run_url, pr_url, target_repo, log, merge_result=cross_repo_pr_open
    - YAML parses without error
    - No changes to the bodies of existing same-repo steps
  </done>
</task>

</tasks>

<verification>
Run after both tasks complete:

```bash
cd "/Users/nwessel/Claude Code/Business/Products/clawforge"
python3 -c "import yaml; d=yaml.safe_load(open('templates/.github/workflows/notify-pr-complete.yml')); print('triggers:', list(d['on'].keys())); print('YAML OK')"
grep -c "pr-result.json" templates/.github/workflows/notify-pr-complete.yml
grep -c "cross_repo" templates/.github/workflows/notify-pr-complete.yml
grep -c "same_repo" templates/.github/workflows/notify-pr-complete.yml
grep -n "job/\*\*" templates/.github/workflows/notify-pr-complete.yml
```

Expected: YAML OK; triggers includes both workflow_run and push; pr-result.json ≥2; cross_repo ≥3; same_repo ≥2; job/** present.
</verification>

<success_criteria>
- notify-pr-complete.yml is valid YAML
- `on:` block has both `workflow_run` (existing) and `push: branches: ['job/**']` (new) triggers
- notify job `if:` condition allows both trigger paths
- Push trigger fires but exits silently (path=skip) when pr-result.json is absent on the branch
- Push trigger sends cross-repo notification when pr-result.json is present, including pr_url and target_repo
- Existing workflow_run (same-repo) path is unchanged and still functional
- Cross-repo payload status field is "cross_repo_pr_open" (distinct from same-repo "completed")
</success_criteria>

<output>
After completion, create `.planning/phases/10-actions-workflow-container-execution-cross-repo-pr/10-03-SUMMARY.md`
</output>
