---
phase: 10-actions-workflow-container-execution-cross-repo-pr
plan: "02"
type: execute
wave: 2
depends_on:
  - "10-01"
files_modified:
  - templates/docker/job/entrypoint.sh
autonomous: true
requirements:
  - PR-02
  - PR-03
  - PR-04
  - PR-05

must_haves:
  truths:
    - "Cross-repo jobs create a PR in the target repo (not clawforge) with branch clawforge/{uuid}"
    - "PR base branch is the target repo's actual default branch, detected via gh repo view (not hardcoded to main)"
    - "PR body contains all four required elements: job description, ClawForge attribution banner, link to originating clawforge job branch, and changes summary placeholder"
    - "PR created as regular open PR (not draft), no labels"
    - "pr-result.json is written to the clawforge job branch logs dir after successful PR creation, containing target_repo, pr_url, pr_number, branch, job_id"
    - "PR creation failure writes pr-error.md to the clawforge job branch and exits 1"
    - "Same-repo path (no target.json) creates PR on clawforge identically to v1.1"
  artifacts:
    - path: "templates/docker/job/entrypoint.sh"
      provides: "Cross-repo branch creation, default branch detection, gh pr create --repo, pr-result.json sidecar"
      contains: "pr-result.json"
    - path: "templates/docker/job/entrypoint.sh"
      provides: "pr-error.md artifact on PR creation failure"
      contains: "pr-error.md"
  key_links:
    - from: "templates/docker/job/entrypoint.sh"
      to: "target repo on GitHub"
      via: "gh pr create --repo TARGET_REPO_SLUG --head clawforge/${JOB_ID} --base DEFAULT_BRANCH"
      pattern: "gh pr create.*--repo"
    - from: "templates/docker/job/entrypoint.sh"
      to: "/job/logs/${JOB_ID}/pr-result.json"
      via: "cat > ${LOG_DIR}/pr-result.json"
      pattern: "pr-result\\.json"
    - from: "templates/.github/workflows/notify-pr-complete.yml"
      to: "/job/logs/${JOB_ID}/pr-result.json"
      via: "push to job/* branch triggers notify workflow which reads pr-result.json"
      pattern: "pr-result"
---

<objective>
Extend the job container entrypoint to execute cross-repo PR creation after Claude completes its work. For cross-repo jobs (WORK_DIR=/workspace): create branch clawforge/{uuid} in the target repo, push Claude's commits, detect the target repo's default branch via gh repo view, create a PR on the target repo via gh pr create --repo, and write pr-result.json sidecar to the clawforge job branch. For same-repo jobs (WORK_DIR=/job): preserve the existing PR creation path unchanged.

Purpose: This is the PR delivery mechanism for cross-repo jobs. Without this, Claude's work in the target repo stays as committed files with no PR. The pr-result.json sidecar is the signal that Plan 10-03's notify-pr-complete.yml extension uses to fire the cross-repo completion notification.

Output: Updated entrypoint.sh with cross-repo PR creation, default branch detection, pr-result.json sidecar, pr-error.md failure artifact, and preserved same-repo PR path.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-actions-workflow-container-execution-cross-repo-pr/10-CONTEXT.md
@.planning/phases/10-actions-workflow-container-execution-cross-repo-pr/10-RESEARCH.md
@templates/docker/job/entrypoint.sh
@.planning/phases/10-actions-workflow-container-execution-cross-repo-pr/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create clawforge/{uuid} branch in target repo and push Claude's commits</name>
  <files>templates/docker/job/entrypoint.sh</files>
  <action>
After section 12a (observability.md generation) and after the `cd /job` inserted by Plan 10-01, add a new cross-repo branch push block. This block runs only when TARGET_REPO_SLUG is set.

Insert before the existing `git add -A` / `git commit` / `git push origin` / `gh pr create` block in section 12:

```bash
# 12b. For cross-repo jobs: push Claude's work to target repo as clawforge/{uuid} branch
if [ -n "$TARGET_REPO_SLUG" ]; then
    # Branch was created in target repo before Claude ran (see section 5b)
    # Push it to the remote target repo
    git -C /workspace push origin "clawforge/${JOB_ID}" || true
    echo "Pushed clawforge/${JOB_ID} to ${TARGET_REPO_SLUG}"
fi
```

Wait — per EXEC-01 and PR-05, the branch must be created in the target repo BEFORE Claude runs (so Claude's commits land on the right branch). Go back to the two-phase clone block from Plan 10-01 (section 5b, after `/workspace` clone succeeds) and add branch creation:

```bash
# After confirming CLONE_EXIT -eq 0 and WORK_DIR=/workspace:
git -C /workspace checkout -b "clawforge/${JOB_ID}"
echo "Created branch clawforge/${JOB_ID} in target repo"
```

Place this immediately after:
```bash
WORK_DIR="/workspace"
echo "Target repo cloned to /workspace. WORK_DIR=/workspace"
```

And before the closing `fi` of the cross-repo clone block.

This ensures that when Claude runs with cwd=/workspace, all its commits go onto the `clawforge/{uuid}` branch. The `git -C /workspace push origin "clawforge/${JOB_ID}"` in section 12b then pushes that branch to the remote.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep -n "checkout -b.*clawforge" templates/docker/job/entrypoint.sh && grep -n "push origin.*clawforge" templates/docker/job/entrypoint.sh && bash -n templates/docker/job/entrypoint.sh && echo "SYNTAX OK"</automated>
    <manual>Confirm: (1) git checkout -b "clawforge/${JOB_ID}" appears in the clone success block (section 5b); (2) git -C /workspace push origin "clawforge/${JOB_ID}" appears in section 12b inside `if [ -n "$TARGET_REPO_SLUG" ]` guard</manual>
  </verify>
  <done>
    - `git -C /workspace checkout -b "clawforge/${JOB_ID}"` present in section 5b cross-repo clone block
    - `git -C /workspace push origin "clawforge/${JOB_ID}"` present in section 12b cross-repo push block
    - Both wrapped in `if [ -n "$TARGET_REPO_SLUG" ]` guard (same-repo path untouched)
    - `bash -n templates/docker/job/entrypoint.sh` exits 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Detect default branch, create PR on target repo, write pr-result.json and pr-error.md sidecars</name>
  <files>templates/docker/job/entrypoint.sh</files>
  <action>
Extend the section 12b cross-repo block (after the push) to: detect default branch, build PR body, create PR on target repo, write pr-result.json on success or pr-error.md on failure.

Replace (or extend) the existing `gh pr create` in section 12 with a branched path:

**Cross-repo path (when TARGET_REPO_SLUG is set) — inside the `if [ -n "$TARGET_REPO_SLUG" ]; then` block:**

```bash
    # Detect target repo's actual default branch (PR-03)
    DEFAULT_BRANCH=$(gh repo view "$TARGET_REPO_SLUG" --json defaultBranchRef -q '.defaultBranchRef.name' 2>/dev/null || echo "main")
    DEFAULT_BRANCH="${DEFAULT_BRANCH:-main}"
    echo "Target default branch: ${DEFAULT_BRANCH}"

    # Build PR body (write to file — avoids shell quoting hazards with multi-line strings) (PR-04)
    JOB_DESCRIPTION_FIRST_LINE=$(echo "$JOB_DESCRIPTION" | head -1 | cut -c1-72)
    CLAWFORGE_REPO=$(echo "$REPO_URL" | sed 's|https://[^/]*/||' | sed 's|\.git$||')
    cat > /tmp/pr-body.md << EOF
> **ClawForge AI-Generated PR** — This pull request was created autonomously by [ClawForge](https://github.com/${CLAWFORGE_REPO}) (job \`${JOB_ID}\`). All AI-generated changes should be reviewed carefully before merging.

## Job Description

${JOB_DESCRIPTION}

## Originating Job

- **ClawForge repo:** \`${CLAWFORGE_REPO}\`
- **Job branch:** \`${BRANCH}\`
- **Job ID:** \`${JOB_ID}\`

## Changes Summary

_Claude Code completed the task above. Review the diff for the full list of changes._
EOF

    # Create PR on target repo (PR-02, PR-04, PR-05)
    set +e
    PR_OUTPUT=$(gh pr create \
        --repo "$TARGET_REPO_SLUG" \
        --head "clawforge/${JOB_ID}" \
        --base "$DEFAULT_BRANCH" \
        --title "clawforge: ${JOB_DESCRIPTION_FIRST_LINE}" \
        --body-file /tmp/pr-body.md 2>&1)
    PR_EXIT=$?
    set -e

    if [ "$PR_EXIT" -ne 0 ]; then
        # Write pr-error.md and push to clawforge job branch
        cat > "${LOG_DIR}/pr-error.md" << EOF
# PR Creation Failure — Job ${JOB_ID}

**Stage:** pr-creation
**Target:** ${TARGET_REPO_SLUG}
**Branch:** clawforge/${JOB_ID}
**Exit code:** ${PR_EXIT}
**Output:** ${PR_OUTPUT}
**Timestamp:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")
EOF
        git -C /job add -A
        git -C /job commit -m "clawforge: job ${JOB_ID} pr-error" || true
        git -C /job push origin || true
        exit 1
    fi

    # Extract PR URL (gh pr create outputs URL on last line)
    PR_URL=$(echo "$PR_OUTPUT" | tail -1)
    PR_NUMBER=$(gh pr view "$PR_URL" --json number -q '.number' 2>/dev/null || echo "")

    # Write pr-result.json sidecar to clawforge job branch (triggers notify-pr-complete.yml push path)
    cat > "${LOG_DIR}/pr-result.json" << EOF
{
  "target_repo": "${TARGET_REPO_SLUG}",
  "pr_url": "${PR_URL}",
  "pr_number": "${PR_NUMBER}",
  "branch": "clawforge/${JOB_ID}",
  "job_id": "${JOB_ID}"
}
EOF
    echo "Cross-repo PR created: ${PR_URL}"
    echo "pr-result.json written to ${LOG_DIR}"
```

**Same-repo path (existing gh pr create block) — keep as-is but guard it with `else` (when TARGET_REPO_SLUG is empty):**

The existing section 12 PR creation block (current `if [ "$CLAUDE_EXIT" -eq 0 ] && [ "$HAS_NEW_COMMIT" = "true" ]; then gh pr create ...`) should only run for same-repo jobs. Wrap it:

```bash
# Same-repo PR creation (unchanged from v1.1) — only when not a cross-repo job
if [ -z "$TARGET_REPO_SLUG" ]; then
    if [ "$CLAUDE_EXIT" -eq 0 ] && [ "$HAS_NEW_COMMIT" = "true" ]; then
        gh pr create \
            --title "clawforge: job ${JOB_ID}" \
            --body "Automated job by ClawForge" \
            --base main || true
    else
        echo "Skipping PR: CLAUDE_EXIT=${CLAUDE_EXIT}, HAS_NEW_COMMIT=${HAS_NEW_COMMIT}"
    fi
fi
```

**After all PR creation logic**, push the clawforge job branch (LOG_DIR artifacts including pr-result.json or pr-error.md):

```bash
# Commit and push all clawforge job branch artifacts (logs, pr-result.json, etc.)
cd /job
git add -A
git add -f "${LOG_DIR}" || true
git commit -m "clawforge: job ${JOB_ID}" || true
git push origin || true
```

Wait — review the existing section 12 commit/push block to avoid double-commit. The existing `git add -A && git commit -m "clawforge: job ${JOB_ID}" && git push origin` must be the FINAL commit that includes all artifacts. Place the cross-repo PR creation (which writes pr-result.json) BEFORE the final git add/commit/push, not after. The sequence should be:

1. `cd /job` (Plan 10-01)
2. Section 12b: cross-repo push `git -C /workspace push ...` (Task 1 above)
3. Section 12b (continued): detect default branch, create PR, write pr-result.json (this task)
4. Record HEAD_BEFORE
5. `git add -A` (picks up pr-result.json, pr-error.md, observability.md, preflight.md)
6. `git commit -m "clawforge: job ${JOB_ID}"`
7. `git push origin`
8. HAS_NEW_COMMIT detection
9. Same-repo `gh pr create` (only when TARGET_REPO_SLUG is empty)

Verify this ordering by reading the current file after Plan 10-01 changes and inserting cross-repo logic in the correct position.

**Critical constraints from CONTEXT.md:**
- PR created as regular open PR (not draft) — do NOT add `--draft` flag
- No labels — do NOT add `--label` flag
- PR author = AGENT_GH_TOKEN owner (handled by gh auth setup-git, no extra config needed)
- Use `--body-file /tmp/pr-body.md` NOT `--body` for multi-line safety (PR-04)
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep -n "gh pr create.*--repo" templates/docker/job/entrypoint.sh && grep -n "pr-result.json" templates/docker/job/entrypoint.sh && grep -n "pr-error.md" templates/docker/job/entrypoint.sh && grep -n "defaultBranchRef" templates/docker/job/entrypoint.sh && grep -n "body-file" templates/docker/job/entrypoint.sh && bash -n templates/docker/job/entrypoint.sh && echo "SYNTAX OK"</automated>
    <manual>Confirm: (1) gh pr create uses --repo TARGET_REPO_SLUG, --head clawforge/${JOB_ID}, --base DEFAULT_BRANCH, --body-file; (2) pr-result.json written with 5 fields; (3) pr-error.md written on PR_EXIT != 0; (4) defaultBranchRef detected via gh repo view; (5) same-repo gh pr create is guarded by [ -z "$TARGET_REPO_SLUG" ]; (6) pr-result.json is written BEFORE the final git add/commit/push</manual>
  </verify>
  <done>
    - `gh pr create --repo "$TARGET_REPO_SLUG" --head "clawforge/${JOB_ID}" --base "$DEFAULT_BRANCH" --body-file /tmp/pr-body.md` exists in cross-repo block
    - DEFAULT_BRANCH detected via `gh repo view "$TARGET_REPO_SLUG" --json defaultBranchRef -q '.defaultBranchRef.name'` with `|| echo "main"` fallback
    - pr-result.json written with fields: target_repo, pr_url, pr_number, branch, job_id
    - pr-error.md written on PR creation failure with stage/target/exit-code/output/timestamp fields
    - Same-repo gh pr create wrapped in `if [ -z "$TARGET_REPO_SLUG" ]` guard
    - pr-result.json written to LOG_DIR before final `git add -A` so it is included in the clawforge commit
    - `bash -n templates/docker/job/entrypoint.sh` exits 0
    - PR body uses `--body-file`, not `--body`
    - No `--draft` or `--label` flags on gh pr create
  </done>
</task>

</tasks>

<verification>
Run after both tasks complete:

```bash
cd "/Users/nwessel/Claude Code/Business/Products/clawforge"
bash -n templates/docker/job/entrypoint.sh && echo "SYNTAX OK"
echo "=== Cross-repo markers ==="
grep -c "TARGET_REPO_SLUG" templates/docker/job/entrypoint.sh
grep -c "pr-result.json" templates/docker/job/entrypoint.sh
grep -c "pr-error.md" templates/docker/job/entrypoint.sh
grep -c "defaultBranchRef" templates/docker/job/entrypoint.sh
grep -c "body-file" templates/docker/job/entrypoint.sh
echo "=== Same-repo guard ==="
grep -n "TARGET_REPO_SLUG.*gh pr create\|gh pr create.*TARGET_REPO_SLUG\|z.*TARGET_REPO_SLUG" templates/docker/job/entrypoint.sh
```

Expected: SYNTAX OK; TARGET_REPO_SLUG ≥8 appearances; pr-result.json ≥3; pr-error.md ≥3; defaultBranchRef ≥1; body-file ≥1.
</verification>

<success_criteria>
- entrypoint.sh passes `bash -n` (no syntax errors)
- Cross-repo path: clawforge/{uuid} branch created in /workspace before Claude runs, pushed to target repo in section 12b
- Cross-repo PR: created on target repo via `gh pr create --repo`, base branch auto-detected, body from /tmp/pr-body.md containing all 4 required elements
- pr-result.json written to ${LOG_DIR} before final git commit on clawforge job branch
- pr-error.md written and committed to clawforge job branch if PR creation fails; container exits 1
- Same-repo PR path (no target.json) unchanged from v1.1 behavior
- No --draft, no --label on gh pr create
</success_criteria>

<output>
After completion, create `.planning/phases/10-actions-workflow-container-execution-cross-repo-pr/10-02-SUMMARY.md`
</output>
