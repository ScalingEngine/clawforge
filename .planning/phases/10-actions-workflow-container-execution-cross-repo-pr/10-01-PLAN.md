---
phase: 10-actions-workflow-container-execution-cross-repo-pr
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/docker/job/entrypoint.sh
  - .planning/REQUIREMENTS.md
autonomous: true
requirements:
  - PR-01
  - EXEC-01
  - EXEC-03

must_haves:
  truths:
    - "When target.json is present on the job branch, the entrypoint clones the target repo to /workspace and sets WORK_DIR=/workspace"
    - "When target.json is absent, the entrypoint behaves identically to v1.1 (WORK_DIR=/job, Claude runs from /job)"
    - "When the target repo clone fails, clone-error.md is written to the clawforge job branch logs dir and the container exits 1"
    - "clone-error.md includes stage, target URL, exit code, and timestamp for Phase 11 failure detection"
    - "PR-01 wording in REQUIREMENTS.md reflects the actual implementation: entrypoint reads target.json directly, run-job.yml is unchanged"
  artifacts:
    - path: "templates/docker/job/entrypoint.sh"
      provides: "Two-phase clone logic with failure guard"
      contains: "target.json"
    - path: "templates/docker/job/entrypoint.sh"
      provides: "clone-error.md artifact write on clone failure"
      contains: "clone-error.md"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Corrected PR-01 wording matching the locked decision (entrypoint reads target.json, run-job.yml unchanged)"
      contains: "entrypoint reads target.json"
  key_links:
    - from: "templates/docker/job/entrypoint.sh"
      to: "/job/logs/${JOB_ID}/target.json"
      via: "jq -r '.repo_url'"
      pattern: "target\\.json"
    - from: "templates/docker/job/entrypoint.sh"
      to: "/workspace"
      via: "git clone --single-branch --depth 1 TARGET_REPO_URL /workspace"
      pattern: "WORK_DIR"
---

<objective>
Extend the job container entrypoint to perform a two-phase clone when a cross-repo job is detected. Phase 1 (existing): clone clawforge job branch to /job to get metadata. Phase 2 (new): if target.json is present, clone the target repo to /workspace and set that as Claude's working directory. If the target clone fails, write clone-error.md to the clawforge job branch and exit 1 — no retry. Also update REQUIREMENTS.md to correct PR-01's wording to reflect the actual locked decision (entrypoint reads target.json directly; run-job.yml is not modified).

Purpose: This is the core runtime change enabling Claude to operate on any allowed target repo's codebase instead of clawforge's own codebase. Without this, cross-repo jobs silently work on the wrong repo. The REQUIREMENTS.md correction ensures PR-01 accurately describes what Phase 10 implements so the gsd-verifier can check the right thing.

Output: Updated entrypoint.sh with two-phase clone, failure guard, and WORK_DIR-based branching for all downstream Claude and git operations. Updated REQUIREMENTS.md with corrected PR-01 wording.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-actions-workflow-container-execution-cross-repo-pr/10-CONTEXT.md
@.planning/phases/10-actions-workflow-container-execution-cross-repo-pr/10-RESEARCH.md
@templates/docker/job/entrypoint.sh
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add two-phase clone logic with WORK_DIR routing to entrypoint.sh</name>
  <files>templates/docker/job/entrypoint.sh</files>
  <action>
Modify `templates/docker/job/entrypoint.sh` to implement the two-phase clone. Insert after section 5 (the existing clone block at line ~38-43), before `cd /job` at line 45. The full sequence:

**After the existing `git clone ... /job` block (section 5), add:**

```bash
# 5b. Detect cross-repo job and clone target repo if applicable (EXEC-01)
WORK_DIR="/job"
TARGET_REPO_URL=""
TARGET_REPO_SLUG=""

if [ -f "/job/logs/${JOB_ID}/target.json" ]; then
    TARGET_REPO_URL=$(jq -r '.repo_url' "/job/logs/${JOB_ID}/target.json")
    TARGET_REPO_SLUG=$(jq -r '.owner + "/" + .slug' "/job/logs/${JOB_ID}/target.json")
    echo "Cross-repo job detected. Target: ${TARGET_REPO_SLUG}"

    # Clone target repo with failure guard (EXEC-03)
    # set -e disabled around clone to capture exit code before writing error artifact
    set +e
    git clone --single-branch --depth 1 "$TARGET_REPO_URL" /workspace 2>&1
    CLONE_EXIT=$?
    set -e

    if [ "$CLONE_EXIT" -ne 0 ]; then
        cat > "/job/logs/${JOB_ID}/clone-error.md" << EOF
# Clone Failure — Job ${JOB_ID}

**Stage:** clone
**Target:** ${TARGET_REPO_URL}
**Exit code:** ${CLONE_EXIT}
**Timestamp:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")

The target repository could not be cloned. Verify AGENT_GH_TOKEN has repo scope on the target repository.
EOF
        git -C /job add -A
        git -C /job commit -m "clawforge: job ${JOB_ID} clone-error" || true
        git -C /job push origin || true
        exit 1
    fi

    WORK_DIR="/workspace"
    echo "Target repo cloned to /workspace. WORK_DIR=/workspace"
fi
```

**Replace `cd /job` (line 45) with:**
```bash
cd "$WORK_DIR"
```

**For sections 7-8c (SOUL/AGENT loading and CLAUDE.md reading):** These still read from `/job` (the clawforge clone), which is correct — config and job description always come from clawforge. Keep `SOUL_FILE`, `AGENT_FILE`, and `JOB_DESCRIPTION` reads pointing at `/job`. Do NOT change those paths.

**For section 8b (REPO_SLUG derivation):** After WORK_DIR is set, derive the repo slug differently for cross-repo jobs:
```bash
# Derive context repo slug — use target repo slug for cross-repo jobs
if [ -n "$TARGET_REPO_SLUG" ]; then
    REPO_SLUG="$TARGET_REPO_SLUG"
else
    REPO_SLUG=$(echo "$REPO_URL" | sed 's|https://[^/]*/||' | sed 's|\.git$||')
fi
```

**For CLAUDE.md reading (section 8b, currently reads `/job/CLAUDE.md`):** Update to read from WORK_DIR:
```bash
if [ -f "${WORK_DIR}/CLAUDE.md" ]; then
    RAW_CLAUDE_MD=$(cat "${WORK_DIR}/CLAUDE.md")
    ...
fi
```

**For package.json reading (section 8b):** Update to read from WORK_DIR:
```bash
if [ -f "${WORK_DIR}/package.json" ]; then
    REPO_STACK=$(jq -r '...' "${WORK_DIR}/package.json" 2>/dev/null ...)
fi
```

**For Claude Code invocation (section 11):** Claude must run with cwd set to WORK_DIR. Since we already `cd "$WORK_DIR"` earlier, the claude invocation does not need changes. Verify: after the WORK_DIR `cd`, confirm no subsequent `cd /job` exists before the claude invocation that would reset the cwd.

**Critical:** The LOG_DIR mkdir still creates to `/job/logs/${JOB_ID}` — that must NOT change. LOG_DIR points into the clawforge clone. Do not cd to /job for the mkdir — use absolute path `mkdir -p "${LOG_DIR}"` (already uses absolute path, confirm this is untouched).

**After section 12a (observability.md generation), for the git commit/push block (section 12):** The `git add -A`, `git commit`, `git push origin`, and `gh pr create` must be performed in `/job` (the clawforge clone), NOT in WORK_DIR. Insert explicit `cd /job` before the commit block:
```bash
# 12. Commit all changes to clawforge job branch
cd /job
```

This is the most critical working-directory discipline point. Review the entire section 12 to confirm all git operations after this `cd /job` use the clawforge working tree.

Also add export of TARGET_REPO_SLUG and TARGET_REPO_URL as env vars so they are available to section 12 PR creation (Phase 10 plan 02 will use them):
```bash
export TARGET_REPO_URL
export TARGET_REPO_SLUG
```
Place these after the WORK_DIR assignment, before entering the `cd "$WORK_DIR"` line.

Do NOT change: the gh pr create at the bottom of section 12 (same-repo PR path). Plan 10-02 will refactor that block. Plan 10-01 only adds the two-phase clone logic.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep -n "WORK_DIR" templates/docker/job/entrypoint.sh | head -20 && grep -n "target.json" templates/docker/job/entrypoint.sh && grep -n "clone-error.md" templates/docker/job/entrypoint.sh && grep -n "CLONE_EXIT" templates/docker/job/entrypoint.sh && bash -n templates/docker/job/entrypoint.sh && echo "SYNTAX OK"</automated>
    <manual>Confirm: (1) grep shows WORK_DIR set to "/job" default then conditionally "/workspace"; (2) target.json read uses jq -r '.repo_url' and '.owner + "/" + .slug'; (3) clone-error.md written with stage/target/exit-code/timestamp fields; (4) bash -n reports no syntax errors</manual>
  </verify>
  <done>
    - `WORK_DIR` variable exists, defaults to `/job`, set to `/workspace` when target.json present
    - `TARGET_REPO_URL` and `TARGET_REPO_SLUG` populated from target.json via jq
    - clone-error.md written to `${LOG_DIR}/clone-error.md` on clone failure with required fields
    - `cd "$WORK_DIR"` used instead of `cd /job` for Claude's working directory
    - `cd /job` inserted before section 12 git commit/push block
    - `bash -n templates/docker/job/entrypoint.sh` exits 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Update FULL_PROMPT Target section and verify CLAUDE.md/package.json read from WORK_DIR</name>
  <files>templates/docker/job/entrypoint.sh</files>
  <action>
After Task 1, audit the FULL_PROMPT construction (section 11) to ensure the "Target" line reflects the actual working repo for cross-repo jobs.

The existing FULL_PROMPT Target section uses `${REPO_SLUG:-unknown}`. Since Task 1 already sets REPO_SLUG to TARGET_REPO_SLUG for cross-repo jobs, this section should work correctly. Verify it is indeed using REPO_SLUG (not a hardcoded value).

Add a cross-repo context hint to FULL_PROMPT when WORK_DIR is /workspace. Insert into the FULL_PROMPT construction after the GSD Hint section:

```bash
# Build cross-repo context note for FULL_PROMPT
CROSS_REPO_NOTE=""
if [ -n "$TARGET_REPO_SLUG" ]; then
    CROSS_REPO_NOTE="

## Cross-Repo Context

You are operating on **${TARGET_REPO_SLUG}** (not the ClawForge repository). Your working directory is the root of that repository. All files you create, edit, or read are in ${TARGET_REPO_SLUG}. Commits will be pushed to a branch named \`clawforge/${JOB_ID}\` on that repository. A pull request will be created on ${TARGET_REPO_SLUG} automatically after your work is committed."
fi
```

Then append `${CROSS_REPO_NOTE}` to FULL_PROMPT after the GSD Hint block:
```bash
FULL_PROMPT="# Your Job
...
## GSD Hint

Recommended: /gsd:${GSD_HINT}
Reason: ${GSD_HINT_REASON}${CROSS_REPO_NOTE}"
```

This ensures Claude knows it is operating on a foreign repo and will not attempt to commit to or create PRs on clawforge.

Also confirm (do not change if correct): the `preflight.md` artifact write in section 6b uses `${LOG_DIR}` which is `/job/logs/${JOB_ID}` — this is correct and must remain pointing at `/job`. Do not move it to WORK_DIR.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep -n "CROSS_REPO_NOTE\|Cross-Repo Context\|clawforge/${JOB_ID}" templates/docker/job/entrypoint.sh && grep -n "REPO_SLUG" templates/docker/job/entrypoint.sh && bash -n templates/docker/job/entrypoint.sh && echo "SYNTAX OK"</automated>
    <manual>Confirm CROSS_REPO_NOTE is appended to FULL_PROMPT and references TARGET_REPO_SLUG. Confirm REPO_SLUG is set to TARGET_REPO_SLUG for cross-repo jobs.</manual>
  </verify>
  <done>
    - CROSS_REPO_NOTE block exists in entrypoint.sh and is appended to FULL_PROMPT
    - CROSS_REPO_NOTE references TARGET_REPO_SLUG and clawforge/{JOB_ID} branch name
    - FULL_PROMPT Target section uses REPO_SLUG which equals TARGET_REPO_SLUG for cross-repo jobs
    - `bash -n templates/docker/job/entrypoint.sh` exits 0
    - No regressions: same-repo path (no target.json) leaves FULL_PROMPT and REPO_SLUG unchanged from v1.1
  </done>
</task>

<task type="auto">
  <name>Task 3: Update PR-01 wording in REQUIREMENTS.md to match locked implementation decision</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
The locked decision in 10-CONTEXT.md states: "run-job.yml stays unchanged — entrypoint reads target.json and handles same-repo vs cross-repo logic internally." PR-01 as written says "run-job.yml reads target.json from job branch and injects TARGET_REPO_URL into container env" — this contradicts the actual implementation.

Update `.planning/REQUIREMENTS.md` to correct PR-01:

**Find the PR-01 line:**
```
- [ ] **PR-01**: run-job.yml reads target.json from job branch and injects TARGET_REPO_URL into container env
```

**Replace with:**
```
- [ ] **PR-01**: Entrypoint reads target.json directly from the clawforge job branch (/job/logs/${JOB_ID}/target.json) and derives TARGET_REPO_URL internally; run-job.yml is unchanged
```

Also update the traceability table note for PR-01 if it has any descriptive text — it currently just shows `| PR-01 | Phase 10 | Pending |` which needs no change.

Do not change any other requirement, the traceability table structure, or any other section of REQUIREMENTS.md. This is a one-line wording correction.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep -n "PR-01" .planning/REQUIREMENTS.md</automated>
    <manual>Confirm PR-01 now says entrypoint reads target.json directly and run-job.yml is unchanged. Confirm no other lines changed.</manual>
  </verify>
  <done>
    - PR-01 in REQUIREMENTS.md no longer references run-job.yml injecting TARGET_REPO_URL
    - PR-01 now states entrypoint reads target.json directly from /job/logs/${JOB_ID}/target.json
    - PR-01 explicitly notes run-job.yml is unchanged
    - All other requirements and the traceability table are unmodified
  </done>
</task>

</tasks>

<verification>
Run after all tasks complete:

```bash
cd "/Users/nwessel/Claude Code/Business/Products/clawforge"
bash -n templates/docker/job/entrypoint.sh && echo "SYNTAX OK"
grep -c "WORK_DIR" templates/docker/job/entrypoint.sh
grep -c "clone-error.md" templates/docker/job/entrypoint.sh
grep -c "target.json" templates/docker/job/entrypoint.sh
grep -c "CROSS_REPO_NOTE" templates/docker/job/entrypoint.sh
grep "PR-01" .planning/REQUIREMENTS.md
```

Expected: SYNTAX OK, WORK_DIR appears ≥5 times, clone-error.md appears ≥3 times, target.json appears ≥2 times, CROSS_REPO_NOTE appears ≥2 times. PR-01 line references entrypoint and does NOT reference run-job.yml injecting env vars.
</verification>

<success_criteria>
- entrypoint.sh passes `bash -n` (no syntax errors)
- Cross-repo path: target.json present → /workspace cloned, WORK_DIR=/workspace, Claude runs in /workspace
- Same-repo path: no target.json → WORK_DIR=/job, behavior identical to v1.1
- Clone failure → clone-error.md written to LOG_DIR with stage/target/exit-code/timestamp, git commit+push to clawforge job branch, exit 1
- FULL_PROMPT Target section shows target repo slug for cross-repo jobs
- FULL_PROMPT includes Cross-Repo Context section warning Claude it's in a foreign repo
- All git commit/push in section 12 still run from /job (clawforge clone)
- PR-01 in REQUIREMENTS.md accurately describes the actual implementation (entrypoint reads target.json, run-job.yml unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/10-actions-workflow-container-execution-cross-repo-pr/10-01-SUMMARY.md`
</output>
