---
phase: 09-config-layer-tool-schema-entrypoint-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/docker/job/defaults/SOUL.md
  - templates/docker/job/defaults/AGENT.md
  - templates/docker/job/Dockerfile
  - templates/docker/job/entrypoint.sh
autonomous: true
requirements:
  - EXEC-02
  - EXEC-04

must_haves:
  truths:
    - "Generic SOUL.md and AGENT.md exist at /defaults/ in the job Docker image"
    - "Entrypoint falls back to /defaults/SOUL.md and /defaults/AGENT.md when /job/config/ versions are absent"
    - "Same-repo jobs still use /job/config/SOUL.md and /job/config/AGENT.md when present (backward compatible)"
    - "No PAT appears in any clone URL — gh auth setup-git handles all git authentication"
    - "entrypoint.sh has an audit comment documenting EXEC-04 compliance"
  artifacts:
    - path: "templates/docker/job/defaults/SOUL.md"
      provides: "Generic ClawForge agent identity for cross-repo jobs"
      min_lines: 5
    - path: "templates/docker/job/defaults/AGENT.md"
      provides: "Generic ClawForge agent instructions for cross-repo jobs"
      min_lines: 10
    - path: "templates/docker/job/Dockerfile"
      provides: "Job image with /defaults/ baked in"
      contains: "/defaults/"
    - path: "templates/docker/job/entrypoint.sh"
      provides: "Entrypoint with SOUL/AGENT fallback logic"
      contains: "/defaults/"
  key_links:
    - from: "templates/docker/job/Dockerfile"
      to: "templates/docker/job/defaults/"
      via: "COPY at build time"
      pattern: "COPY defaults.*\\/defaults"
    - from: "templates/docker/job/entrypoint.sh"
      to: "/defaults/SOUL.md"
      via: "fallback test in step 7"
      pattern: "SOUL_FILE.*defaults"
---

<objective>
Bake generic SOUL.md and AGENT.md into the job Docker image at /defaults/ and update the entrypoint to fall back to those defaults when /job/config/ versions are absent. Audit and document EXEC-04 compliance (no PAT in clone URLs).

Purpose: Cross-repo jobs clone a foreign repo to /job/ which has no config/ directory. Without defaults baked into the image, the system prompt would be empty. This ensures all jobs get a system prompt regardless of target repo.
Output: Generic defaults files, updated Dockerfile with COPY, updated entrypoint with fallback logic, EXEC-04 audit comment.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-config-layer-tool-schema-entrypoint-foundation/09-RESEARCH.md
@templates/docker/job/Dockerfile
@templates/docker/job/entrypoint.sh
@instances/noah/config/SOUL.md
@instances/noah/config/AGENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generic /defaults/ SOUL.md and AGENT.md, update Dockerfile</name>
  <files>
    templates/docker/job/defaults/SOUL.md
    templates/docker/job/defaults/AGENT.md
    templates/docker/job/Dockerfile
  </files>
  <action>
**Create templates/docker/job/defaults/SOUL.md** — Generic ClawForge agent identity (NOT instance-specific persona like "Archie" or "Epic"). This is a neutral identity for the shared job image:

```markdown
# ClawForge — Autonomous Code Agent

You are a ClawForge autonomous agent executing a job in an isolated Docker container. You have full filesystem access and tool capabilities within this container.

## Core Behavior

- Every change you make is committed to git and becomes a pull request
- You are executing a specific task — focus on that task
- Use GSD workflow skills when available for structured work
- Be thorough but pragmatic — ship working code
```

**Create templates/docker/job/defaults/AGENT.md** — Generic agent instructions without instance-specific identity, channels, or persona. Include the GSD usage block that is common across both instances (from Phase 4 instruction hardening):

```markdown
# Agent Instructions

## Git

You are operating on a job branch. All changes are committed and pushed automatically after your work completes. A PR is created targeting the repository's default branch.

## Working Style

- Read existing code before making changes — understand patterns and conventions
- Make targeted changes — do not refactor unrelated code
- Write clear commit messages describing what changed and why
- If the task is unclear, do your best interpretation and document assumptions

## GSD Usage — Required Behavior

You MUST use the Skill tool to invoke GSD commands for all substantial tasks. Do NOT use Write, Edit, or Bash directly for implementation work without first routing through GSD.

- For quick, targeted changes: `/gsd:quick`
- For multi-step implementation: `/gsd:plan-phase`
```

**Update templates/docker/job/Dockerfile** — Add COPY commands for defaults BEFORE the COPY entrypoint.sh line (before line 67). Insert:

```dockerfile
# Bake generic SOUL/AGENT defaults for cross-repo jobs (EXEC-02)
# When /job/config/ is absent (foreign repo), entrypoint falls back to /defaults/
RUN mkdir -p /defaults
COPY defaults/SOUL.md /defaults/SOUL.md
COPY defaults/AGENT.md /defaults/AGENT.md
```

Place this block after the `COPY hooks/...` and settings merge section (after line 62), before `RUN mkdir -p /workspace /workspace/.claude` (line 65).
  </action>
  <verify>
    <automated>test -f templates/docker/job/defaults/SOUL.md && test -f templates/docker/job/defaults/AGENT.md && grep -c "/defaults/" templates/docker/job/Dockerfile</automated>
    <manual>Verify defaults contain generic identity (no "Archie"/"Epic"), and Dockerfile COPY comes before ENTRYPOINT</manual>
  </verify>
  <done>Generic SOUL.md and AGENT.md exist in templates/docker/job/defaults/. Dockerfile copies them to /defaults/ in the image. No instance-specific persona in the generic defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Update entrypoint with /defaults/ fallback and EXEC-04 audit comment</name>
  <files>
    templates/docker/job/entrypoint.sh
  </files>
  <action>
**Update entrypoint.sh step 7 (lines 85-93)** — Replace the current SOUL/AGENT loading block with a version that falls back to /defaults/ when /job/config/ files are absent:

Replace:
```bash
# 7. Build system prompt from config files
SYSTEM_PROMPT=""
if [ -f "/job/config/SOUL.md" ]; then
    SYSTEM_PROMPT=$(cat /job/config/SOUL.md)
    SYSTEM_PROMPT="${SYSTEM_PROMPT}\n\n"
fi
if [ -f "/job/config/AGENT.md" ]; then
    SYSTEM_PROMPT="${SYSTEM_PROMPT}$(cat /job/config/AGENT.md)"
fi
```

With:
```bash
# 7. Build system prompt from config files (with /defaults/ fallback for cross-repo jobs)
SYSTEM_PROMPT=""
SOUL_FILE="/job/config/SOUL.md"
AGENT_FILE="/job/config/AGENT.md"

# Fall back to baked-in defaults when working in a foreign repo (EXEC-02)
[ ! -f "$SOUL_FILE" ]  && SOUL_FILE="/defaults/SOUL.md"
[ ! -f "$AGENT_FILE" ] && AGENT_FILE="/defaults/AGENT.md"

if [ -f "$SOUL_FILE" ]; then
    SYSTEM_PROMPT=$(cat "$SOUL_FILE")
    SYSTEM_PROMPT="${SYSTEM_PROMPT}\n\n"
fi
if [ -f "$AGENT_FILE" ]; then
    SYSTEM_PROMPT="${SYSTEM_PROMPT}$(cat "$AGENT_FILE")"
fi
```

**Add EXEC-04 audit comment** — After step 4 (line 31, after `git config --global user.email`), add:
```bash
# EXEC-04 compliance: gh auth setup-git (line 26) handles all git credential resolution.
# REPO_URL is set by Actions workflow as "https://github.com/owner/repo.git" — no PAT interpolated.
# PAT flows only via GH_TOKEN env var (from SECRETS JSON), consumed by gh CLI. Never in clone URLs.
```

This is a documentation-only addition for EXEC-04 — no functional change needed since the current implementation is already compliant.
  </action>
  <verify>
    <automated>grep -c "/defaults/" templates/docker/job/entrypoint.sh && grep -c "EXEC-04" templates/docker/job/entrypoint.sh</automated>
    <manual>Verify fallback logic: when /job/config/SOUL.md is absent, SOUL_FILE switches to /defaults/SOUL.md. When present, /job/config/ is still used (backward compatible).</manual>
  </verify>
  <done>Entrypoint falls back to /defaults/SOUL.md and /defaults/AGENT.md when /job/config/ versions are absent. EXEC-04 compliance is documented with an audit comment. Same-repo jobs still use /job/config/ when present.</done>
</task>

</tasks>

<verification>
1. `templates/docker/job/defaults/SOUL.md` exists with generic ClawForge identity (no instance persona)
2. `templates/docker/job/defaults/AGENT.md` exists with generic agent instructions including GSD block
3. `templates/docker/job/Dockerfile` has COPY lines for both defaults files to /defaults/
4. `templates/docker/job/entrypoint.sh` step 7 uses variable-based file paths with /defaults/ fallback
5. EXEC-04 audit comment present in entrypoint.sh
6. Backward compatibility: /job/config/ files still take precedence when present
</verification>

<success_criteria>
- Generic defaults contain no instance-specific persona (no "Archie", no "Epic")
- Entrypoint fallback is transparent — same-repo behavior unchanged
- EXEC-04 is documented with clear explanation of why no PAT leak exists
- Dockerfile builds successfully with the new COPY lines
</success_criteria>

<output>
After completion, create `.planning/phases/09-config-layer-tool-schema-entrypoint-foundation/09-02-SUMMARY.md`
</output>
