---
phase: 09-config-layer-tool-schema-entrypoint-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - instances/noah/config/REPOS.json
  - instances/strategyES/config/REPOS.json
  - lib/tools/repos.js
  - instances/noah/Dockerfile
  - instances/strategyES/Dockerfile
  - .env.example
autonomous: true
requirements:
  - CFG-01
  - CFG-02
  - TOOL-02

must_haves:
  truths:
    - "Each instance has a REPOS.json config file defining allowed target repos with owner, slug, name, and aliases"
    - "loadAllowedRepos() reads REPOS.json from config/ directory at runtime and returns the repos array"
    - "resolveTargetRepo() matches a natural language input against slug, name, or aliases and returns the canonical repo entry or null"
    - "Event Handler Dockerfiles COPY REPOS.json into the container at ./config/REPOS.json"
    - ".env.example documents the PAT scope requirements for cross-repo targeting"
  artifacts:
    - path: "instances/noah/config/REPOS.json"
      provides: "Noah instance allowed repos config"
      contains: "clawforge"
    - path: "instances/strategyES/config/REPOS.json"
      provides: "StrategyES instance allowed repos config (stub)"
      contains: "strategyes-lab"
    - path: "lib/tools/repos.js"
      provides: "Repo loading and resolution logic"
      exports: ["loadAllowedRepos", "resolveTargetRepo"]
    - path: "instances/noah/Dockerfile"
      provides: "Noah Event Handler image with REPOS.json"
      contains: "REPOS.json"
    - path: "instances/strategyES/Dockerfile"
      provides: "StrategyES Event Handler image with REPOS.json"
      contains: "REPOS.json"
  key_links:
    - from: "lib/tools/repos.js"
      to: "config/REPOS.json"
      via: "fs.readFileSync at runtime"
      pattern: "readFileSync.*REPOS\\.json"
    - from: "instances/noah/Dockerfile"
      to: "instances/noah/config/REPOS.json"
      via: "COPY at build time"
      pattern: "COPY.*REPOS\\.json.*config"
---

<objective>
Create per-instance REPOS.json config files defining allowed target repos, implement the repo loading and resolution module, update Event Handler Dockerfiles to include REPOS.json, and document PAT scope requirements.

Purpose: Establishes the configuration foundation that the agent tool layer needs to validate and resolve target repo references from natural language input.
Output: REPOS.json files for both instances, lib/tools/repos.js module, updated Dockerfiles, updated .env.example.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-config-layer-tool-schema-entrypoint-foundation/09-RESEARCH.md
@lib/paths.js
@instances/noah/Dockerfile
@instances/strategyES/Dockerfile
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create REPOS.json configs and repos.js resolver module</name>
  <files>
    instances/noah/config/REPOS.json
    instances/strategyES/config/REPOS.json
    lib/tools/repos.js
  </files>
  <action>
Create two REPOS.json files and one resolver module:

**instances/noah/config/REPOS.json:**
```json
{
  "repos": [
    {
      "owner": "ScalingEngine",
      "slug": "clawforge",
      "name": "ClawForge",
      "aliases": ["clawforge", "cf", "the bot"]
    },
    {
      "owner": "ScalingEngine",
      "slug": "neurostory",
      "name": "NeuroStory",
      "aliases": ["neurostory", "ns", "the app"]
    }
  ]
}
```

**instances/strategyES/config/REPOS.json:**
```json
{
  "repos": [
    {
      "owner": "ScalingEngine",
      "slug": "strategyes-lab",
      "name": "StrategyES Lab",
      "aliases": ["strategyes-lab", "strategyes", "lab"]
    }
  ]
}
```

**lib/tools/repos.js:**
Create a new module with two exported functions following codebase conventions (ESM, named exports, JSDoc, camelCase):

- `loadAllowedRepos()` — reads `config/REPOS.json` from `PROJECT_ROOT` (import from `../paths.js`). Uses `fs.readFileSync` in a try/catch, returns `repos` array or `[]` on failure. Read on every call (no caching — file is <1KB, changes require container rebuild).

- `resolveTargetRepo(input, repos)` — takes a string input and the repos array. Returns the matching repo object or null. Match algorithm: case-insensitive comparison against `slug`, `name`, and each entry in `aliases[]`. Uses `.find()` with `.toLowerCase()` matching.

Import `fs` from 'fs', `path` from 'path', `PROJECT_ROOT` from '../paths.js'. Follow existing patterns: use `path.join(PROJECT_ROOT, 'config', 'REPOS.json')` for file path.
  </action>
  <verify>
    <automated>node -e "import { loadAllowedRepos, resolveTargetRepo } from './lib/tools/repos.js'; const r = loadAllowedRepos(); console.log('loaded:', r.length, 'repos'); const m = resolveTargetRepo('cf', r); console.log('resolved cf:', m ? m.slug : 'null'); const n = resolveTargetRepo('nonexistent', r); console.log('resolved nonexistent:', n);" 2>&1 | head -20</automated>
    <manual>Verify REPOS.json files exist with correct structure in both instance config dirs</manual>
  </verify>
  <done>Both REPOS.json files exist with correct structure. loadAllowedRepos() loads repos from config/REPOS.json. resolveTargetRepo() matches by slug/name/alias and returns null for unrecognized input.</done>
</task>

<task type="auto">
  <name>Task 2: Update Event Handler Dockerfiles and document PAT scope</name>
  <files>
    instances/noah/Dockerfile
    instances/strategyES/Dockerfile
    .env.example
  </files>
  <action>
**instances/noah/Dockerfile** — Add a COPY line for REPOS.json immediately after the existing AGENT.md COPY (line 40):
```dockerfile
COPY instances/noah/config/REPOS.json ./config/REPOS.json
```

**instances/strategyES/Dockerfile** — Same pattern, after the AGENT.md COPY (line 40):
```dockerfile
COPY instances/strategyES/config/REPOS.json ./config/REPOS.json
```

**.env.example** — Add PAT scope documentation for cross-repo targeting. After the existing `NOAH_GH_TOKEN=` line, add a comment block:
```
# v1.2 Cross-Repo Targeting: Fine-grained PAT must include:
#   - contents:write on all repos in REPOS.json (read/write code on job branches)
#   - pull_requests:write on all repos in REPOS.json (create PRs on target repos)
#   - Current PAT scope: clawforge only. Update in GitHub Settings > Developer Settings > Fine-grained tokens.
```

Add a similar comment after `SES_GH_TOKEN=`:
```
# v1.2 Cross-Repo Targeting: Fine-grained PAT must include:
#   - contents:write on all repos in REPOS.json (read/write code on job branches)
#   - pull_requests:write on all repos in REPOS.json (create PRs on target repos)
#   - Current PAT scope: strategyes-lab only. Update if adding cross-repo targets.
```
  </action>
  <verify>
    <automated>grep -c "REPOS.json" instances/noah/Dockerfile instances/strategyES/Dockerfile && grep -c "cross-repo\|Cross-Repo" .env.example</automated>
    <manual>Verify Dockerfile COPY line is positioned after AGENT.md COPY, and .env.example comments are clear</manual>
  </verify>
  <done>Both Event Handler Dockerfiles copy REPOS.json into container at ./config/REPOS.json. .env.example documents PAT scope requirements for cross-repo targeting on both instances.</done>
</task>

</tasks>

<verification>
1. `instances/noah/config/REPOS.json` and `instances/strategyES/config/REPOS.json` exist with valid JSON structure
2. `lib/tools/repos.js` exports `loadAllowedRepos` and `resolveTargetRepo`
3. Both Event Handler Dockerfiles include `COPY ... REPOS.json ./config/REPOS.json`
4. `.env.example` documents PAT scope requirements for cross-repo targeting
5. Resolution works: "cf" -> clawforge, "NeuroStory" -> neurostory, "nonexistent" -> null
</verification>

<success_criteria>
- REPOS.json files define allowed repos with owner, slug, name, aliases
- Resolver module loads and matches repos correctly (case-insensitive, slug/name/alias)
- Dockerfiles bake REPOS.json into Event Handler image at runtime path
- PAT documentation is clear and actionable for operator
</success_criteria>

<output>
After completion, create `.planning/phases/09-config-layer-tool-schema-entrypoint-foundation/09-01-SUMMARY.md`
</output>
