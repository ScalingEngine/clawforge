---
phase: 08-polish-test-sync
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test-entrypoint.sh
  - .planning/REQUIREMENTS.md
  - .planning/phases/07-previous-job-context/07-01-SUMMARY.md
autonomous: true
requirements: [TEST-01, HIST-01]

must_haves:
  truths:
    - "test-entrypoint.sh uses /tmp/prompt.txt file redirect matching production delivery mechanism"
    - "test-entrypoint.sh constructs a structured FULL_PROMPT with Target, Docs, Stack, Task, GSD Hint sections"
    - "REQUIREMENTS.md traceability table shows HIST-01 as Complete"
    - "07-01-SUMMARY.md has requirements-completed frontmatter field"
  artifacts:
    - path: "tests/test-entrypoint.sh"
      provides: "Test entrypoint aligned with production prompt format"
      contains: "/tmp/prompt.txt"
    - path: "tests/test-entrypoint.sh"
      provides: "Structured 5-section FULL_PROMPT"
      contains: "## GSD Hint"
    - path: ".planning/phases/07-previous-job-context/07-01-SUMMARY.md"
      provides: "requirements-completed frontmatter field"
      contains: "requirements-completed:"
  key_links:
    - from: "tests/test-entrypoint.sh"
      to: "templates/docker/job/entrypoint.sh"
      via: "structural alignment — same prompt sections and delivery mechanism"
      pattern: "printf.*prompt\\.txt.*claude -p.*< /tmp/prompt\\.txt"
---

<objective>
Align test-entrypoint.sh with production prompt format and fix two documentation tracking artifacts.

Purpose: FINDING-2 from the v1.1 milestone audit identified that the test harness diverged from production after Phase 6 (uses old pipe delivery, lacks structured prompt sections). Two documentation items (HIST-01 traceability status, 07-01-SUMMARY.md missing frontmatter) also need correction.

Output: Test harness exercises the same prompt structure and delivery mechanism as production. Documentation artifacts are accurate.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.1-MILESTONE-AUDIT.md
@.planning/phases/08-polish-test-sync/08-RESEARCH.md
@templates/docker/job/entrypoint.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Align test-entrypoint.sh with production prompt format</name>
  <files>tests/test-entrypoint.sh</files>
  <action>
Replace the FULL_PROMPT construction and claude invocation in `tests/test-entrypoint.sh` (approximately lines 59-72) with a structured prompt matching production's 5-section format and file-redirect delivery.

**Replace the old FULL_PROMPT block:**
```bash
FULL_PROMPT="# Your Job

${JOB_DESCRIPTION}"
```

**With the production-aligned structure using stub values for non-test sections:**
```bash
FULL_PROMPT="# Your Job

## Target

test-repo

## Repository Documentation

[not present — test fixture does not include CLAUDE.md]

## Stack

[not present — test fixture does not include package.json]

## Task

${JOB_DESCRIPTION}

## GSD Hint

Recommended: /gsd:quick
Reason: test harness — always uses quick"
```

**Replace the pipe delivery** (the line `printf '%s' "${FULL_PROMPT}" | claude -p ...`) **with file-redirect delivery:**
```bash
printf '%s' "${FULL_PROMPT}" > /tmp/prompt.txt

claude -p \
    --output-format json \
    --append-system-prompt "$(cat /tmp/system-prompt.md)" \
    --allowedTools "Read,Write,Edit,Bash,Glob,Grep,Task,Skill" \
    < /tmp/prompt.txt \
    2>&1 | tee "${LOG_DIR}/claude-output.jsonl" || true
```

IMPORTANT: Preserve `|| true` (existing pattern) instead of production's `|| CLAUDE_EXIT=$?` — either is acceptable, but `|| true` is simpler for the test harness where the exit code is not needed for downstream logic. Also preserve the existing `set -e` and `set -x` lines at the top of the script.

Reference production entrypoint at `templates/docker/job/entrypoint.sh` lines 183-216 for the canonical structure. The test does NOT need real CLAUDE.md or package.json content — stub values are sufficient because the goal is structural alignment (same sections, same delivery mechanism), not content fidelity.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep -c "## Target\|## Repository Documentation\|## Stack\|## Task\|## GSD Hint" tests/test-entrypoint.sh && grep "/tmp/prompt.txt" tests/test-entrypoint.sh && grep "< /tmp/prompt.txt" tests/test-entrypoint.sh</automated>
    <manual>Confirm the test entrypoint has all 5 structured sections and uses file redirect delivery</manual>
  </verify>
  <done>test-entrypoint.sh constructs a 5-section FULL_PROMPT (Target, Repository Documentation, Stack, Task, GSD Hint) matching production structure. Prompt is written to /tmp/prompt.txt and piped to claude -p via file redirect. Old pipe delivery is gone.</done>
</task>

<task type="auto">
  <name>Task 2: Fix documentation tracking artifacts</name>
  <files>.planning/REQUIREMENTS.md, .planning/phases/07-previous-job-context/07-01-SUMMARY.md</files>
  <action>
**REQUIREMENTS.md (idempotent check):**
Read `.planning/REQUIREMENTS.md` and check the HIST-01 traceability row (approximately line 110). If it already shows `| HIST-01 | Phase 7 (v1.1) | Complete |`, no edit is needed — mark this sub-task as already satisfied and move on. If it shows "Pending", change it to "Complete".

The research noted this may already be fixed (the file appears as modified in the working tree). Verify before editing.

**07-01-SUMMARY.md:**
In `.planning/phases/07-previous-job-context/07-01-SUMMARY.md`, locate the frontmatter line `requirements: [HIST-01, HIST-04]` (line 32). Add a new line immediately after it:
```yaml
requirements-completed: [HIST-01, HIST-04]
```

This follows the established pattern from `06-01-SUMMARY.md` line 46 which has `requirements-completed: [PROMPT-01, PROMPT-02, PROMPT-03, PROMPT-04]`. Insert before the closing `---` of the frontmatter block.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep "HIST-01.*Complete" .planning/REQUIREMENTS.md && grep "requirements-completed:" .planning/phases/07-previous-job-context/07-01-SUMMARY.md</automated>
    <manual>Confirm HIST-01 shows Complete in traceability table and 07-01-SUMMARY.md has requirements-completed field</manual>
  </verify>
  <done>REQUIREMENTS.md traceability table shows HIST-01 as Complete. 07-01-SUMMARY.md frontmatter includes requirements-completed: [HIST-01, HIST-04].</done>
</task>

</tasks>

<verification>
1. `grep -c "## Target\|## Repository Documentation\|## Stack\|## Task\|## GSD Hint" tests/test-entrypoint.sh` returns 5
2. `grep "/tmp/prompt.txt" tests/test-entrypoint.sh` shows file redirect (not pipe)
3. `grep "< /tmp/prompt.txt" tests/test-entrypoint.sh` confirms stdin redirect to claude
4. `grep "HIST-01.*Complete" .planning/REQUIREMENTS.md` shows Complete status
5. `grep "requirements-completed:" .planning/phases/07-previous-job-context/07-01-SUMMARY.md` shows the field exists
</verification>

<success_criteria>
- test-entrypoint.sh uses file redirect (/tmp/prompt.txt) matching production
- test-entrypoint.sh has all 5 structured prompt sections (Target, Repository Documentation, Stack, Task, GSD Hint)
- REQUIREMENTS.md HIST-01 traceability row shows "Complete"
- 07-01-SUMMARY.md has requirements-completed frontmatter field
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-test-sync/08-02-SUMMARY.md`
</output>
