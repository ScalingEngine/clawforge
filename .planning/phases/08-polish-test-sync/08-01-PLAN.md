---
phase: 08-polish-test-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/index.js
  - lib/ai/index.js
  - .github/workflows/notify-pr-complete.yml
  - templates/.github/workflows/notify-pr-complete.yml
autonomous: true
requirements: [PIPE-02, OBSV-03]

must_haves:
  truths:
    - "A failed job notification message in Slack/Telegram includes the failure stage label (docker_pull/auth/claude)"
    - "notify-pr-complete.yml finds gsd-invocations.jsonl by explicit name, not fragile wildcard"
    - "Live workflow and template workflow are byte-for-byte identical after the fix"
  artifacts:
    - path: "api/index.js"
      provides: "failure_stage extraction from webhook payload into results object"
      contains: "failure_stage: payload.failure_stage"
    - path: "lib/ai/index.js"
      provides: "failure_stage section in summarizeJob userMessage assembly"
      contains: "results.failure_stage"
    - path: ".github/workflows/notify-pr-complete.yml"
      provides: "Explicit gsd-invocations.jsonl lookup"
      contains: 'find.*-name "gsd-invocations.jsonl"'
    - path: "templates/.github/workflows/notify-pr-complete.yml"
      provides: "Template synced with live workflow"
      contains: 'find.*-name "gsd-invocations.jsonl"'
  key_links:
    - from: "api/index.js"
      to: "lib/ai/index.js"
      via: "results object passed to summarizeJob()"
      pattern: "failure_stage.*summarizeJob"
    - from: ".github/workflows/notify-pr-complete.yml"
      to: "templates/.github/workflows/notify-pr-complete.yml"
      via: "byte-for-byte template sync"
      pattern: 'find.*-name "gsd-invocations.jsonl"'
---

<objective>
Surface failure_stage in human-facing job failure notifications and fix the fragile JSONL wildcard in notify-pr-complete.yml.

Purpose: FINDING-1 from the v1.1 milestone audit identified that `failure_stage` (docker_pull/auth/claude) is correctly computed and transmitted in the webhook payload but never rendered in the Slack/Telegram notification message. Separately, notify-pr-complete.yml uses `find *.jsonl` which depends on inode creation order — fragile when both gsd-invocations.jsonl and claude-output.jsonl exist in the log directory.

Output: Two runtime behaviour fixes — operators see failure stage in notifications, and the correct JSONL file is always found.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.1-MILESTONE-AUDIT.md
@.planning/phases/08-polish-test-sync/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Surface failure_stage in notification messages</name>
  <files>api/index.js, lib/ai/index.js</files>
  <action>
In `api/index.js`, locate the `handleGithubWebhook` function's `results` object construction (approximately lines 258-268). Add `failure_stage: payload.failure_stage || '',` after the `status` line. Do NOT modify `notify-job-failed.yml` — the workflow already correctly computes and sends failure_stage.

In `lib/ai/index.js`, locate the `summarizeJob` function's `userMessage` array assembly (approximately lines 246-255). Add a new line after the `results.status` entry:
```javascript
results.failure_stage ? `## Failure Stage\n${results.failure_stage}` : '',
```

Do NOT modify the system prompt (jobSummaryMd via lib/paths.js). The field names are self-explanatory to the LLM — adding `## Failure Stage\ndocker_pull` to userMessage is sufficient for the model to incorporate it into the summary.

Both changes follow the existing pattern: conditional inclusion with `.filter(Boolean)` stripping empty entries.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep -n "failure_stage" api/index.js && grep -n "failure_stage" lib/ai/index.js</automated>
    <manual>Confirm failure_stage appears in both the results object and the userMessage assembly</manual>
  </verify>
  <done>api/index.js extracts failure_stage from webhook payload into results object. lib/ai/index.js includes a conditional ## Failure Stage section in the userMessage array passed to the LLM. No other files modified.</done>
</task>

<task type="auto">
  <name>Task 2: Fix JSONL wildcard in notify-pr-complete.yml and sync template</name>
  <files>.github/workflows/notify-pr-complete.yml, templates/.github/workflows/notify-pr-complete.yml</files>
  <action>
In `.github/workflows/notify-pr-complete.yml`, find the line (approximately line 86):
```bash
LOG_FILE=$(find "$LOG_DIR" -name "*.jsonl" -type f | head -1)
```

Replace with:
```bash
LOG_FILE=$(find "$LOG_DIR" -name "gsd-invocations.jsonl" -type f | head -1)
```

Keep `head -1` as a guard for the case where no matching file is found.

Then copy `.github/workflows/notify-pr-complete.yml` byte-for-byte to `templates/.github/workflows/notify-pr-complete.yml` to maintain PIPE-05 compliance. Use `cp` to ensure exact sync, then verify with `diff` that both files are identical.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep "gsd-invocations.jsonl" .github/workflows/notify-pr-complete.yml && diff .github/workflows/notify-pr-complete.yml templates/.github/workflows/notify-pr-complete.yml</automated>
    <manual>Confirm the wildcard is replaced with explicit filename in both files and diff shows no differences</manual>
  </verify>
  <done>Both the live workflow and template use `find -name "gsd-invocations.jsonl"` instead of `find -name "*.jsonl"`. The two files are byte-for-byte identical.</done>
</task>

</tasks>

<verification>
1. `grep -n "failure_stage" api/index.js` shows the field in the results object
2. `grep -n "failure_stage" lib/ai/index.js` shows the conditional section in userMessage
3. `grep "gsd-invocations.jsonl" .github/workflows/notify-pr-complete.yml` shows explicit filename
4. `diff .github/workflows/notify-pr-complete.yml templates/.github/workflows/notify-pr-complete.yml` returns empty (byte-for-byte match)
</verification>

<success_criteria>
- failure_stage field flows from webhook payload through results object into summarizeJob's userMessage
- notify-pr-complete.yml uses explicit filename lookup, not fragile wildcard
- Live workflow and template are byte-for-byte identical
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-test-sync/08-01-SUMMARY.md`
</output>
