---
phase: 03-test-harness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test-job.sh
  - tests/test-entrypoint.sh
  - tests/validate-output.sh
  - tests/fixtures/gsd-test-job.md
  - tests/fixtures/AGENT.md
  - tests/fixtures/SOUL.md
  - .gitignore
autonomous: true
requirements: [TEST-01]

must_haves:
  truths:
    - "Running `ANTHROPIC_API_KEY=sk-... bash tests/test-job.sh` builds the Docker image, runs a test container, and produces PASS/FAIL output"
    - "`validate-output.sh` exits 0 when gsd-invocations.jsonl has at least one record"
    - "`validate-output.sh` exits 1 when gsd-invocations.jsonl is empty or missing"
    - "The test runs without GitHub credentials, Slack tokens, or any production secrets beyond ANTHROPIC_API_KEY"
    - "tests/output/ is gitignored so test artifacts are never committed"
  artifacts:
    - path: "tests/test-job.sh"
      provides: "Top-level operator-facing test runner"
      contains: "docker build"
    - path: "tests/test-entrypoint.sh"
      provides: "Bypass entrypoint that skips git clone/push/PR, runs core claude -p steps"
      contains: "claude -p"
    - path: "tests/validate-output.sh"
      provides: "Assertion script that checks gsd-invocations.jsonl for GSD calls"
      contains: "gsd-invocations.jsonl"
    - path: "tests/fixtures/gsd-test-job.md"
      provides: "Synthetic job description requiring Skill(gsd:quick) invocation"
      contains: "MUST"
    - path: "tests/fixtures/AGENT.md"
      provides: "Minimal AGENT.md with imperative GSD usage instructions"
      contains: "MUST use Skill tool"
    - path: "tests/fixtures/SOUL.md"
      provides: "Minimal SOUL.md identity for test container"
  key_links:
    - from: "tests/test-job.sh"
      to: "tests/test-entrypoint.sh"
      via: "bind mount + --entrypoint override"
      pattern: "-v.*test-entrypoint\\.sh:/test-entrypoint\\.sh"
    - from: "tests/test-entrypoint.sh"
      to: "docker/job/hooks/gsd-invocations.js"
      via: "PostToolUse hook in Docker image settings.json writes to /output/gsd-invocations.jsonl"
      pattern: "export LOG_DIR"
    - from: "tests/validate-output.sh"
      to: "tests/output/gsd-invocations.jsonl"
      via: "reads JSONL file and counts records"
      pattern: "grep -c \\."
    - from: "tests/test-job.sh"
      to: "tests/validate-output.sh"
      via: "calls validate-output.sh after docker run completes"
      pattern: "bash.*validate-output\\.sh"
---

<objective>
Build the local Docker test harness that proves the full GSD chain end-to-end without production credentials.

Purpose: Operators need a single command (`bash tests/test-job.sh`) that builds the job container locally, runs a synthetic job requiring GSD Skill invocation, and asserts that gsd-invocations.jsonl captured the call. This replaces the current blind-faith approach where the only way to know if GSD works is to trigger a real production job via Slack/Telegram.

Output: 6 new files in `tests/` (runner, bypass entrypoint, validator, 3 fixtures) plus .gitignore update for `tests/output/`.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-test-harness/03-RESEARCH.md
@.planning/phases/02-output-observability/02-01-SUMMARY.md
@docker/job/entrypoint.sh
@docker/job/Dockerfile
@docker/job/hooks/gsd-invocations.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fixture files and test-entrypoint.sh bypass</name>
  <files>
    tests/fixtures/gsd-test-job.md
    tests/fixtures/AGENT.md
    tests/fixtures/SOUL.md
    tests/test-entrypoint.sh
  </files>
  <action>
Create the `tests/fixtures/` directory and three fixture files, then the test-entrypoint.sh bypass script.

**tests/fixtures/gsd-test-job.md** — Synthetic job description. Use imperative language that leaves zero ambiguity:
```markdown
# Test Job: GSD Chain Verification

**Purpose:** Confirm that the GSD Skill tool is correctly wired in this Docker container.

## Instructions

You MUST complete this task using the Skill tool with `gsd:quick`. Do not use Write, Edit, or Bash to accomplish this task directly.

Call:
```
Skill("gsd:quick")
```

With the argument:
> Create the file /output/test-result.md containing exactly this text: "GSD test completed successfully."

The test harness is validating that `Skill` was invoked. If you complete the task without calling `Skill`, the test will fail.
```

**tests/fixtures/AGENT.md** — Minimal agent instructions with imperative GSD wording:
```markdown
# Agent Instructions

You are a test agent running inside a ClawForge job container.

## Tool Usage

You MUST use the Skill tool for all tasks. Call `Skill("gsd:quick")` to execute tasks. Do NOT use Write, Edit, or Bash directly to accomplish tasks described in the job description.

This is a test environment. The Skill tool invocation is being monitored.
```

**tests/fixtures/SOUL.md** — Minimal identity:
```markdown
# Test Agent

You are a test agent. Follow the instructions in AGENT.md exactly.
```

**tests/test-entrypoint.sh** — Bypass entrypoint that replicates production steps 6-12a without git clone/push/PR. Critical details:
- `set -e` for fail-fast
- `JOB_ID` from `TEST_JOB_ID` env var or default `test-$(date +%s)`
- `LOG_DIR="/output"` exported BEFORE claude runs (pitfall 2 from research)
- `touch "${LOG_DIR}/gsd-invocations.jsonl"` baseline (same as production)
- Preflight block: echo HOME, `which claude`, GSD directory listing, fail-fast if GSD missing
- Read fixtures from `/fixtures/` (SOUL.md, AGENT.md, gsd-test-job.md) — mounted by test-job.sh
- Build FULL_PROMPT with `# Your Job\n\n${JOB_DESCRIPTION}` (same as production step 11)
- Run `printf '%s' "${FULL_PROMPT}" | claude -p` with same flags as production: `--output-format json`, `--append-system-prompt`, `--allowedTools "Read,Write,Edit,Bash,Glob,Grep,Task,Skill"`. Pipe output to `tee "${LOG_DIR}/claude-output.json"`. Append `|| true` so non-zero claude exit does not kill the script.
- After claude exits, generate observability.md from gsd-invocations.jsonl using same jq logic as production step 12a
- `chmod +x` on test-entrypoint.sh

Use `echo -e` for SYSTEM_PROMPT variable interpolation (same as production). Use `cat /tmp/system-prompt.md` approach or direct `--append-system-prompt` inline — match whichever pattern the production entrypoint uses for the system prompt file. Production writes system prompt to `/tmp/system-prompt.md` then reads it back, so replicate that.
  </action>
  <verify>
    <automated>test -f tests/fixtures/gsd-test-job.md && test -f tests/fixtures/AGENT.md && test -f tests/fixtures/SOUL.md && test -f tests/test-entrypoint.sh && test -x tests/test-entrypoint.sh && grep -q "MUST" tests/fixtures/gsd-test-job.md && grep -q "MUST use Skill tool" tests/fixtures/AGENT.md && grep -q "export LOG_DIR" tests/test-entrypoint.sh && grep -q "claude -p" tests/test-entrypoint.sh && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
    - tests/fixtures/gsd-test-job.md exists with imperative "MUST" language requiring Skill("gsd:quick")
    - tests/fixtures/AGENT.md exists with imperative "MUST use Skill tool" instruction
    - tests/fixtures/SOUL.md exists with minimal identity
    - tests/test-entrypoint.sh exists, is executable, exports LOG_DIR before claude -p, reads fixtures from /fixtures/, generates observability.md after claude exits
    - test-entrypoint.sh has NO git clone, git push, or gh pr create commands
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test-job.sh runner, validate-output.sh, and update .gitignore</name>
  <files>
    tests/test-job.sh
    tests/validate-output.sh
    .gitignore
  </files>
  <action>
Create the operator-facing runner script and the assertion script, then update .gitignore.

**tests/test-job.sh** — Top-level runner. Must be the single command an operator runs:
- `set -e` for fail-fast
- Resolve `SCRIPT_DIR` and `REPO_ROOT` (SCRIPT_DIR is `$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)`, REPO_ROOT is `$(cd "$SCRIPT_DIR/.." && pwd)`)
- `OUTPUT_DIR="${SCRIPT_DIR}/output"`
- Print banner: `=== ClawForge GSD Test Harness ===`
- Check `ANTHROPIC_API_KEY` is set, exit 1 with usage message if not: `"ERROR: ANTHROPIC_API_KEY must be set\nUsage: ANTHROPIC_API_KEY=sk-... bash tests/test-job.sh"`
- Step [1/4]: `docker build -t clawforge-job-test "${REPO_ROOT}/docker/job" --quiet` (use `--quiet` to suppress build output unless there is an error)
- Step [2/4]: Clean output dir: `rm -rf "${OUTPUT_DIR}" && mkdir -p "${OUTPUT_DIR}"`
- Step [3/4]: `docker run --rm` with:
  - `-e ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY}"`
  - `-e TEST_JOB_ID="test-$(date +%s)"`
  - `-v "${SCRIPT_DIR}/fixtures:/fixtures:ro"`
  - `-v "${SCRIPT_DIR}/test-entrypoint.sh:/test-entrypoint.sh:ro"` (bind mount, no Dockerfile change — pitfall 4 from research)
  - `-v "${OUTPUT_DIR}:/output:rw"`
  - `--entrypoint /bin/bash` then `clawforge-job-test /test-entrypoint.sh` (not `--entrypoint /test-entrypoint.sh` directly, to avoid exec format errors if shebang is missed)
- Step [4/4]: `bash "${SCRIPT_DIR}/validate-output.sh" "${OUTPUT_DIR}"`
- Print `PASS — GSD chain verified` and list output artifacts
- `chmod +x` on test-job.sh

**tests/validate-output.sh** — Assertion script:
- `set -e`
- Accept `OUTPUT_DIR` as `$1`, default to `$(dirname "${BASH_SOURCE[0]}")/output`
- `JSONL_FILE="${OUTPUT_DIR}/gsd-invocations.jsonl"`
- Print banner: `=== Validate GSD Invocations ===`
- Assert file exists: exit 1 with `"FAIL: gsd-invocations.jsonl not found"` if missing
- Count non-empty lines: `RECORD_COUNT=$(grep -c . "${JSONL_FILE}" 2>/dev/null || echo 0)`
- If count is 0: exit 1 with `"FAIL: gsd-invocations.jsonl is empty — GSD Skill tool was not invoked"`, also cat observability.md and tail of claude-output.json for diagnostic context
- If count > 0: exit 0 with `"PASS: N GSD invocation(s) found"`, list each skill via `jq -r '"  Skill(\(.skill)) at \(.ts)"'` (with fallback `cat` if jq fails)
- `chmod +x` on validate-output.sh

**.gitignore** — Append `tests/output/` on a new line at the end of the file. Do NOT modify any existing lines. Just add the one line.
  </action>
  <verify>
    <automated>test -f tests/test-job.sh && test -x tests/test-job.sh && test -f tests/validate-output.sh && test -x tests/validate-output.sh && grep -q "ANTHROPIC_API_KEY" tests/test-job.sh && grep -q "gsd-invocations.jsonl" tests/validate-output.sh && grep -q "docker build" tests/test-job.sh && grep -q "docker run" tests/test-job.sh && grep -q "tests/output" .gitignore && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
    - tests/test-job.sh exists, is executable, checks for ANTHROPIC_API_KEY, runs docker build + docker run with bind mounts for fixtures/entrypoint/output, calls validate-output.sh
    - tests/validate-output.sh exists, is executable, exits 1 when JSONL empty/missing, exits 0 when JSONL has records
    - .gitignore contains `tests/output/` entry
    - No production files modified (Dockerfile, entrypoint.sh untouched)
  </done>
</task>

</tasks>

<verification>
**Structural verification (no API key needed):**
1. All 6 test files exist with correct permissions: `ls -la tests/test-job.sh tests/test-entrypoint.sh tests/validate-output.sh tests/fixtures/gsd-test-job.md tests/fixtures/AGENT.md tests/fixtures/SOUL.md`
2. test-entrypoint.sh exports LOG_DIR before claude: `grep -n "export LOG_DIR" tests/test-entrypoint.sh` returns a line before `claude -p`
3. test-entrypoint.sh has NO git operations: `grep -c "git clone\|git push\|gh pr" tests/test-entrypoint.sh` returns 0
4. validate-output.sh handles both PASS and FAIL: `grep -c "exit 0\|exit 1" tests/validate-output.sh` returns at least 2
5. Fixture job uses imperative language: `grep "MUST" tests/fixtures/gsd-test-job.md` returns match
6. .gitignore has output entry: `grep "tests/output" .gitignore` returns match

**Live validation (requires ANTHROPIC_API_KEY):**
Run `ANTHROPIC_API_KEY=sk-... bash tests/test-job.sh` and verify it completes with `PASS — GSD chain verified`.
</verification>

<success_criteria>
- `tests/test-job.sh` exists and is executable — the single command an operator runs
- `tests/test-entrypoint.sh` bypasses git clone/push/PR while replicating production claude -p execution with identical tool whitelist and hook wiring
- `tests/validate-output.sh` asserts against `gsd-invocations.jsonl` (NOT `tool-usage.json`), exits 0 on success, exits 1 on failure
- Fixture files use imperative "MUST" language to maximize GSD invocation reliability
- `tests/output/` is gitignored
- No production files modified (docker/job/Dockerfile, docker/job/entrypoint.sh unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/03-test-harness/03-01-SUMMARY.md`
</output>
