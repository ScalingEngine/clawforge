---
phase: 13-tool-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/ai/tools.js
  - lib/ai/agent.js
  - package.json
  - package-lock.json
autonomous: true
requirements:
  - INTAKE-01

must_haves:
  truths:
    - "Sending 'create a new instance' to Archie produces a create_instance_job tool-call attempt, not an unknown-tool error"
    - "Calling create_instance_job with a valid config object dispatches a job and returns job_id + branch without crashing"
    - "Calling create_instance_job with a missing required field (e.g. omitting name) returns a Zod validation error identifying the field — agent stays running"
    - "Server restart after adding the tool does not corrupt existing SQLite checkpoint threads"
    - "yaml package is importable in the codebase (ready for Phase 15)"
  artifacts:
    - path: "lib/ai/tools.js"
      provides: "createInstanceJobTool definition with Zod schema and stub handler"
      exports: ["createJobTool", "getJobStatusTool", "getSystemTechnicalSpecsTool", "createInstanceJobTool"]
      contains: "create_instance_job"
    - path: "lib/ai/agent.js"
      provides: "Agent singleton with createInstanceJobTool registered in tools array"
      contains: "createInstanceJobTool"
    - path: "package.json"
      provides: "yaml dependency declared"
      contains: "\"yaml\""
  key_links:
    - from: "lib/ai/agent.js"
      to: "lib/ai/tools.js"
      via: "named import createInstanceJobTool"
      pattern: "import.*createInstanceJobTool.*from.*tools\\.js"
    - from: "lib/ai/agent.js"
      to: "createInstanceJobTool"
      via: "tools array passed to createReactAgent"
      pattern: "createInstanceJobTool"
    - from: "createInstanceJobTool handler"
      to: "lib/tools/create-job.js createJob()"
      via: "direct function call"
      pattern: "createJob\\(description\\)"
---

<objective>
Register createInstanceJobTool in the LangGraph agent tools array with a validated Zod schema and stub handler. Install the yaml dependency for use in Phase 15.

Purpose: Establish the structured config contract that all downstream v1.3 phases depend on. Without the tool in the agent tools array, the LLM cannot emit a create_instance_job tool-call — intake (Phase 14) and job prompt (Phase 15) work would be unreachable.

Output: Updated lib/ai/tools.js (new tool definition + export), updated lib/ai/agent.js (tool registered), yaml added to package.json.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/ai/tools.js
@lib/ai/agent.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add createInstanceJobTool to tools.js and install yaml</name>
  <files>lib/ai/tools.js, package.json, package-lock.json</files>
  <action>
Install the yaml package first:
```
npm install yaml@^2.8.2
```
This adds yaml to package.json dependencies and updates package-lock.json. yaml is ESM-native and comment-preserving — required for Phase 15 docker-compose.yml modification. Do not use js-yaml (CommonJS-only, incompatible with "type": "module" project).

Then add createInstanceJobTool to lib/ai/tools.js. Add it after the getSystemTechnicalSpecsTool definition, before the export line. Follow the exact pattern of createJobTool:

1. The tool handler receives (config, runConfig) — capture thread_id from runConfig?.configurable?.thread_id for saveJobOrigin() call (same as createJobTool — 3 lines, prevents Phase 15 regression where instance job completions don't route back to conversation).

2. Build a minimal stub job description (Phase 15 will replace this with buildInstanceJobDescription(config)):
```javascript
const description = [
  `# Create ClawForge Instance: ${config.name}`,
  '',
  `**Purpose:** ${config.purpose}`,
  `**Allowed repos:** ${config.allowed_repos.join(', ')}`,
  `**Channels:** ${config.enabled_channels.join(', ')}`,
  config.slack_user_ids?.length ? `**Slack users:** ${config.slack_user_ids.join(', ')}` : '',
  config.telegram_chat_id ? `**Telegram chat ID:** ${config.telegram_chat_id}` : '',
  '',
  'Generate all instance files per the ClawForge instance generator spec.',
].filter(Boolean).join('\n');
```

3. Call createJob(description) — no targetRepo needed (instance files always live in clawforge repo).

4. Call saveJobOrigin(result.job_id, threadId, detectPlatform(threadId)) in a try/catch with console.error on failure (matching createJobTool pattern exactly).

5. Return JSON.stringify({ success: true, job_id: result.job_id, branch: result.branch }).

6. Tool config object:
- name: 'create_instance_job' (snake_case — LangGraph routes by exact string match; camelCase will cause "Tool not found" crash)
- description: 'Create a new ClawForge instance. Dispatches an autonomous job that generates all instance files (Dockerfile, SOUL.md, AGENT.md, EVENT_HANDLER.md, REPOS.json, .env.example) and updates docker-compose.yml. Call this only after collecting all required config and receiving operator approval.'
- schema: z.object({
    name: z.string().describe('Instance slug — lowercase, no spaces (e.g. "jim", "acmecorp")'),
    purpose: z.string().describe('What this instance is for, used to author persona files'),
    allowed_repos: z.array(z.string()).describe('GitHub repo slugs this instance can target (e.g. ["strategyes-lab"])'),
    enabled_channels: z.array(z.enum(['slack', 'telegram', 'web'])).describe('Communication channels to enable'),
    slack_user_ids: z.array(z.string()).optional().describe('Slack user IDs that can interact with this instance'),
    telegram_chat_id: z.string().optional().describe('Telegram chat ID for this instance'),
  })

Do NOT use .transform() on any schema field — transforms break LangChain JSON Schema serialization. Use plain Zod types only.

7. Update the export line at the bottom of tools.js to include createInstanceJobTool:
```javascript
export { createJobTool, getJobStatusTool, getSystemTechnicalSpecsTool, createInstanceJobTool };
```

Add JSDoc block above the tool definition following project convention (all exported functions have JSDoc). Example:
```javascript
/**
 * LangGraph tool for creating a new ClawForge instance.
 * Phase 13 stub — handler builds a minimal job description.
 * Phase 15 will replace the description with buildInstanceJobDescription(config).
 */
```
  </action>
  <verify>
    <automated>node -e "import('/Users/nwessel/Claude Code/Business/Products/clawforge/lib/ai/tools.js').then(m => { console.log('exports:', Object.keys(m)); console.log('has createInstanceJobTool:', 'createInstanceJobTool' in m); }).catch(e => { console.error(e); process.exit(1); })"</automated>
    <manual>Confirm output shows: exports: [ 'createJobTool', 'getJobStatusTool', 'getSystemTechnicalSpecsTool', 'createInstanceJobTool' ] and has createInstanceJobTool: true</manual>
  </verify>
  <done>lib/ai/tools.js exports createInstanceJobTool. package.json contains yaml@^2.8.2. Node can import the tools module without error.</done>
</task>

<task type="auto">
  <name>Task 2: Register createInstanceJobTool in agent.js tools array</name>
  <files>lib/ai/agent.js</files>
  <action>
In lib/ai/agent.js, make two changes:

1. Update the import line at the top to include createInstanceJobTool:
```javascript
import { createJobTool, getJobStatusTool, getSystemTechnicalSpecsTool, createInstanceJobTool } from './tools.js';
```

2. In the getAgent() function, add createInstanceJobTool to the tools array:
```javascript
const tools = [createJobTool, getJobStatusTool, getSystemTechnicalSpecsTool, createInstanceJobTool];
```

The tool order does not matter for LangGraph routing — it routes by exact tool name string match, not array position.

No other changes. Do not modify the checkpointer, prompt, or singleton pattern. The existing _agent singleton and resetAgent() export remain unchanged.

Note: The running server will NOT pick up the new tool until restarted. This is expected behavior (singleton pattern). The executor should NOT restart the server — that is an operator action after the PR merges.
  </action>
  <verify>
    <automated>node -e "import('/Users/nwessel/Claude Code/Business/Products/clawforge/lib/ai/agent.js').then(m => { console.log('agent exports:', Object.keys(m)); }).catch(e => { console.error(e.message); process.exit(1); })"</automated>
    <manual>Confirm the import resolves without error. Also verify: grep -n 'createInstanceJobTool' lib/ai/agent.js shows both the import line and the tools array line.</manual>
  </verify>
  <done>lib/ai/agent.js imports createInstanceJobTool and includes it in the tools array passed to createReactAgent. Module resolves without import errors.</done>
</task>

</tasks>

<verification>
Run these checks after both tasks complete:

1. Both modified files export/use createInstanceJobTool correctly:
```bash
grep -n 'createInstanceJobTool' lib/ai/tools.js lib/ai/agent.js
```
Expected: 4+ matches — definition in tools.js, export in tools.js, import in agent.js, array entry in agent.js.

2. yaml package installed:
```bash
node -e "import('yaml').then(m => console.log('yaml version:', m.default?.version || 'ok')).catch(e => { console.error(e.message); process.exit(1); })"
```
Expected: prints yaml version or 'ok' without error.

3. Tool name is snake_case (not camelCase — would cause "Tool not found" crash):
```bash
grep "name:" lib/ai/tools.js | grep instance
```
Expected: `name: 'create_instance_job'`

4. No .transform() calls in the new tool schema:
```bash
grep -A 30 "create_instance_job" lib/ai/tools.js | grep "transform"
```
Expected: no output.

5. saveJobOrigin is called in the createInstanceJobTool handler (for notification routing):
```bash
grep -A 60 "create_instance_job" lib/ai/tools.js | grep "saveJobOrigin"
```
Expected: saveJobOrigin appears inside the handler.
</verification>

<success_criteria>
- createInstanceJobTool is defined in lib/ai/tools.js with snake_case name 'create_instance_job'
- Zod schema has 4 required fields (name, purpose, allowed_repos, enabled_channels) and 2 optional fields (slack_user_ids, telegram_chat_id)
- No .transform() calls in the schema
- createInstanceJobTool is exported from tools.js and imported + registered in agent.js tools array
- yaml@^2.8.2 is in package.json dependencies
- Both files import cleanly via Node.js dynamic import (no syntax errors)
- saveJobOrigin is called in the handler so instance job completions route back to originating thread
</success_criteria>

<output>
After completion, create `.planning/phases/13-tool-infrastructure/13-01-SUMMARY.md`
</output>
