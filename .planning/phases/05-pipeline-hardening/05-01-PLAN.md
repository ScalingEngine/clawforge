---
phase: 05-pipeline-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/job/entrypoint.sh
  - .github/workflows/run-job.yml
  - tests/test-entrypoint.sh
  - tests/validate-output.sh
autonomous: true
requirements:
  - PIPE-01
  - PIPE-03
  - PIPE-04

must_haves:
  truths:
    - "A job where Claude exits 0 but makes no file changes does NOT open a PR"
    - "A job where Claude exits non-zero does NOT open a PR regardless of commits"
    - "A job where Claude exits 0 AND produces commits opens a PR as before"
    - "Claude output is written to claude-output.jsonl (not .json)"
    - "Test files reference claude-output.jsonl consistently"
    - "A hung job is terminated after 30 minutes and triggers failure notification"
  artifacts:
    - path: "docker/job/entrypoint.sh"
      provides: "Zero-commit guard via SHA comparison, .jsonl output naming"
      contains: "HEAD_BEFORE"
    - path: ".github/workflows/run-job.yml"
      provides: "Job-level timeout"
      contains: "timeout-minutes"
    - path: "tests/test-entrypoint.sh"
      provides: "Test entrypoint with .jsonl naming"
      contains: "claude-output.jsonl"
    - path: "tests/validate-output.sh"
      provides: "Validation script with .jsonl naming"
      contains: "claude-output.jsonl"
  key_links:
    - from: "docker/job/entrypoint.sh"
      to: "PR creation"
      via: "HEAD_BEFORE vs HEAD_AFTER SHA comparison gates gh pr create"
      pattern: "HEAD_BEFORE.*HEAD_AFTER"
    - from: "docker/job/entrypoint.sh"
      to: "logs/${JOB_ID}/claude-output.jsonl"
      via: "tee output target"
      pattern: "claude-output\\.jsonl"
    - from: ".github/workflows/run-job.yml"
      to: "notify-job-failed.yml"
      via: "timeout-minutes triggers timed_out conclusion caught by != success"
      pattern: "timeout-minutes"
---

<objective>
Add zero-commit PR guard, rename output file to .jsonl, and add runner timeout.

Purpose: Three of five pipeline hardening requirements are independent entrypoint/workflow changes that can be made in parallel. This plan groups them because they touch different concerns in the same files and should land together.

Output: Modified `entrypoint.sh` with SHA-based commit detection and .jsonl naming, `run-job.yml` with timeout, and updated test files.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pipeline-hardening/05-RESEARCH.md
@docker/job/entrypoint.sh
@.github/workflows/run-job.yml
@tests/test-entrypoint.sh
@tests/validate-output.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add zero-commit PR guard and rename output to .jsonl in entrypoint.sh</name>
  <files>docker/job/entrypoint.sh, tests/test-entrypoint.sh, tests/validate-output.sh</files>
  <action>
In `docker/job/entrypoint.sh`:

1. **Rename output file (PIPE-03):** On line 135, change `claude-output.json` to `claude-output.jsonl`:
   ```
   2>&1 | tee "${LOG_DIR}/claude-output.jsonl" || CLAUDE_EXIT=$?
   ```

2. **Add SHA-based zero-commit detection (PIPE-01):** Before the `git add -A` block (current line 170), record the HEAD SHA:
   ```bash
   # Record HEAD before commit to detect if commit produces new changes
   HEAD_BEFORE=$(git rev-parse HEAD)
   ```

3. **Track commit result:** Replace the current commit/push/PR block (lines 170-181) with:
   ```bash
   # Record HEAD before commit to detect if commit produces new changes
   HEAD_BEFORE=$(git rev-parse HEAD)

   git add -A
   git add -f "${LOG_DIR}" || true
   git commit -m "clawforge: job ${JOB_ID}" || true
   git push origin || true

   # Detect if commit actually created a new SHA (handles shallow clone safely)
   HEAD_AFTER=$(git rev-parse HEAD)
   HAS_NEW_COMMIT=false
   if [ "$HEAD_BEFORE" != "$HEAD_AFTER" ]; then
       HAS_NEW_COMMIT=true
   fi

   # Create PR only if Claude succeeded AND produced commits
   if [ "$CLAUDE_EXIT" -eq 0 ] && [ "$HAS_NEW_COMMIT" = "true" ]; then
       gh pr create \
           --title "clawforge: job ${JOB_ID}" \
           --body "Automated job by ClawForge" \
           --base main || true
   else
       echo "Skipping PR: CLAUDE_EXIT=${CLAUDE_EXIT}, HAS_NEW_COMMIT=${HAS_NEW_COMMIT}"
   fi
   ```

4. **Update comment on line 169:** Change `# 12. Commit all changes` to `# 12. Commit all changes and conditionally create PR` or similar.

In `tests/test-entrypoint.sh`:
- Line 72: Change `claude-output.json` to `claude-output.jsonl`

In `tests/validate-output.sh`:
- Line 29: Change `claude-output.json` (in echo) to `claude-output.jsonl`
- Line 30: Change `claude-output.json` (in tail command) to `claude-output.jsonl`

Use `claude-output.jsonl` everywhere. Do NOT change the `--output-format json` flag on the claude command itself — only the tee filename changes. The research confirms this is a naming convention alignment, not a format change.
  </action>
  <verify>
    <automated>grep -c "claude-output\.json[^l]" docker/job/entrypoint.sh tests/test-entrypoint.sh tests/validate-output.sh | grep -v ":0$" | wc -l | xargs test 0 -eq</automated>
    <manual>Verify HEAD_BEFORE/HEAD_AFTER pattern in entrypoint.sh around the git commit block</manual>
  </verify>
  <done>
    - entrypoint.sh uses `claude-output.jsonl` as the tee target
    - entrypoint.sh records HEAD SHA before git add, compares after git commit, only calls `gh pr create` when CLAUDE_EXIT=0 AND HEAD changed
    - tests/test-entrypoint.sh references `claude-output.jsonl`
    - tests/validate-output.sh references `claude-output.jsonl`
    - No remaining references to `claude-output.json` (without the `l`) in any of these files
  </done>
</task>

<task type="auto">
  <name>Task 2: Add job-level timeout to run-job.yml</name>
  <files>.github/workflows/run-job.yml</files>
  <action>
In `.github/workflows/run-job.yml`, add `timeout-minutes: 30` to the `run-agent` job definition. Place it after the `runs-on` line (line 8) and before the `if` line (line 9):

```yaml
jobs:
  run-agent:
    runs-on: ${{ vars.RUNS_ON || 'ubuntu-latest' }}
    timeout-minutes: 30
    if: github.ref_type == 'branch' && startsWith(github.ref_name, 'job/')
```

Hardcode 30 minutes per research recommendation. Do NOT use `vars.JOB_TIMEOUT_MINUTES` — the `fromJSON()` workaround adds unnecessary complexity for 2 instances. A static value is sufficient and can be made configurable later if needed.

The `timed_out` conclusion is already caught by `notify-job-failed.yml`'s condition `conclusion != 'success'`, so no changes needed there for timeout support.
  </action>
  <verify>
    <automated>grep -q "timeout-minutes: 30" .github/workflows/run-job.yml && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
    - `run-job.yml` has `timeout-minutes: 30` on the `run-agent` job
    - A job exceeding 30 minutes will be terminated by GitHub Actions and trigger notify-job-failed.yml
  </done>
</task>

</tasks>

<verification>
1. `grep -c "claude-output\.json[^l]" docker/job/entrypoint.sh tests/test-entrypoint.sh tests/validate-output.sh` — all lines return `:0`
2. `grep "HEAD_BEFORE\|HEAD_AFTER\|HAS_NEW_COMMIT" docker/job/entrypoint.sh` — shows the SHA comparison pattern
3. `grep "timeout-minutes" .github/workflows/run-job.yml` — shows `timeout-minutes: 30`
4. `grep "claude-output.jsonl" docker/job/entrypoint.sh tests/test-entrypoint.sh tests/validate-output.sh` — all three files reference .jsonl
</verification>

<success_criteria>
- Zero references to `claude-output.json` (without `l`) in entrypoint.sh, test-entrypoint.sh, validate-output.sh
- entrypoint.sh has SHA-based commit detection gating PR creation
- run-job.yml has `timeout-minutes: 30`
- All changes are syntactically valid bash/yaml
</success_criteria>

<output>
After completion, create `.planning/phases/05-pipeline-hardening/05-01-SUMMARY.md`
</output>
