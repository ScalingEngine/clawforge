---
phase: 01-foundation-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .gitignore
  - docker/job/entrypoint.sh
autonomous: true
requirements:
  - SECR-01
  - FOUND-01
  - FOUND-02
  - OBSV-01

must_haves:
  truths:
    - ".env.vps cannot be accidentally staged by git add -A"
    - "claude -p receives the job prompt via stdin and does not produce 'Input must be provided' error"
    - "Every job run produces a logs/{jobId}/preflight.md file showing HOME, claude path, GSD directory contents, and working directory"
    - "Entrypoint exits non-zero if GSD directory is missing at runtime"
  artifacts:
    - path: ".gitignore"
      provides: ".env.vps exclusion"
      contains: ".env.vps"
    - path: "docker/job/entrypoint.sh"
      provides: "Fixed prompt delivery, preflight diagnostics, GSD runtime check"
      contains: "printf '%s' \"${FULL_PROMPT}\" | claude -p"
  key_links:
    - from: "docker/job/entrypoint.sh"
      to: "claude -p (stdin)"
      via: "printf pipe"
      pattern: "printf '%s' .* \\| claude -p"
    - from: "docker/job/entrypoint.sh"
      to: "logs/{jobId}/preflight.md"
      via: "cat heredoc write"
      pattern: "preflight\\.md"
---

<objective>
Fix the critical prompt delivery bug, add runtime GSD verification with preflight diagnostics, and lock credentials out of git.

Purpose: The job container currently fails every run with "Input must be provided" because `claude -p` receives an empty positional argument. This plan fixes prompt delivery via stdin pipe, adds a preflight diagnostic block that writes `preflight.md` (making every job self-documenting), verifies GSD is present before wasting tokens, and prevents `.env.vps` from being committed.

Output: Updated `docker/job/entrypoint.sh` with stdin pipe, preflight block, and GSD runtime check. Updated `.gitignore` with `.env.vps`.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-fix/01-RESEARCH.md
@docker/job/entrypoint.sh
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add .env.vps to .gitignore and fix prompt delivery via stdin pipe</name>
  <files>.gitignore, docker/job/entrypoint.sh</files>
  <action>
**Step 1 — SECR-01: .gitignore**

Add `.env.vps` to `.gitignore` immediately after the existing credentials block. The file currently has:
```
# Credentials - NEVER commit these
.env
.env.local
*.pem
*.key
```

Add a new line `.env.vps` after `.env.local` so the block becomes:
```
# Credentials - NEVER commit these
.env
.env.local
.env.vps
*.pem
*.key
```

**Step 2 — FOUND-01: Fix claude -p invocation in docker/job/entrypoint.sh**

In `docker/job/entrypoint.sh`, replace the current claude invocation block (lines 86-91):
```bash
claude -p \
    --output-format json \
    --append-system-prompt "$(cat /tmp/system-prompt.md)" \
    --allowedTools "${ALLOWED_TOOLS}" \
    "${FULL_PROMPT}" \
    2>&1 | tee "${LOG_DIR}/claude-output.json" || true
```

With the stdin pipe pattern:
```bash
printf '%s' "${FULL_PROMPT}" | claude -p \
    --output-format json \
    --append-system-prompt "$(cat /tmp/system-prompt.md)" \
    --allowedTools "${ALLOWED_TOOLS}" \
    2>&1 | tee "${LOG_DIR}/claude-output.json" || true
```

The key change: remove `"${FULL_PROMPT}"` as a positional argument and prepend `printf '%s' "${FULL_PROMPT}" |` to pipe the prompt via stdin. This avoids shell positional argument parsing issues with multi-line strings that caused the "Input must be provided" error in both production job runs.

Also add a diagnostic line BEFORE the claude invocation (after the "Running Claude Code" echo on line 85):
```bash
echo "FULL_PROMPT length: ${#FULL_PROMPT}"
```

This makes future failures diagnosable per RESEARCH.md open question 1 recommendation. If FULL_PROMPT is ever empty, this line will show "FULL_PROMPT length: 0" in GitHub Actions logs.
  </action>
  <verify>
    <automated>cd /Users/nwessel/Claude\ Code/Business/Products/clawforge && grep -q '.env.vps' .gitignore && grep -q "printf '%s'" docker/job/entrypoint.sh && ! grep -q '"${FULL_PROMPT}"' docker/job/entrypoint.sh && grep -q 'FULL_PROMPT length' docker/job/entrypoint.sh && echo "PASS" || echo "FAIL"</automated>
    <manual>Verify .gitignore has .env.vps in credentials block. Verify entrypoint.sh uses printf pipe pattern and no longer passes FULL_PROMPT as positional arg.</manual>
  </verify>
  <done>.env.vps is in .gitignore. claude -p receives prompt via stdin pipe. FULL_PROMPT length is logged before invocation. The positional argument "${FULL_PROMPT}" is removed from the claude command.</done>
</task>

<task type="auto">
  <name>Task 2: Add preflight diagnostic block and GSD runtime verification to entrypoint</name>
  <files>docker/job/entrypoint.sh</files>
  <action>
**FOUND-02 + OBSV-01: Preflight block in docker/job/entrypoint.sh**

Insert a preflight section AFTER the logs directory setup (after line 47: `mkdir -p "${LOG_DIR}"`) and BEFORE the system prompt build (before line 49: `# 7. Build system prompt from config files`).

Add this block between step 6 and step 7:

```bash
# 6b. Preflight check — verify environment before wasting claude tokens
echo "=== PREFLIGHT ==="
echo "HOME: ${HOME}"
echo "claude path: $(which claude)"
echo "GSD directory: ${HOME}/.claude/commands/gsd/"
ls "${HOME}/.claude/commands/gsd/" 2>/dev/null || echo "WARNING: GSD directory not found"
echo "Working directory: $(pwd)"
echo "Job ID: ${JOB_ID}"

# Verify GSD is present (fail-fast)
if [ ! -d "${HOME}/.claude/commands/gsd/" ]; then
    echo "ERROR: GSD not installed at ${HOME}/.claude/commands/gsd/" | tee "${LOG_DIR}/preflight.md"
    exit 1
fi

# Write preflight artifact (committed with job output)
cat > "${LOG_DIR}/preflight.md" << EOF
# Preflight — Job ${JOB_ID}

| Item | Value |
|------|-------|
| HOME | ${HOME} |
| claude | $(which claude) |
| GSD directory | ${HOME}/.claude/commands/gsd/ |
| Working directory | $(pwd) |
| Timestamp | $(date -u +"%Y-%m-%dT%H:%M:%SZ") |

## GSD Commands Present

$(ls "${HOME}/.claude/commands/gsd/")
EOF

echo "=== PREFLIGHT COMPLETE ==="
```

Important implementation notes:
- Use `${HOME}` not `/root/` — future-proofs against USER directive changes (per RESEARCH.md pitfall 3).
- The `exit 1` on missing GSD is intentional: if GSD is not installed, the job should fail immediately rather than run `claude -p` without GSD capabilities.
- The `preflight.md` is written to `${LOG_DIR}` which is `logs/{JOB_ID}/`, so it gets committed with the PR via the existing `git add -f "${LOG_DIR}"` on line 95.
- The `2>/dev/null` on the `ls` prevents stderr noise if directory doesn't exist (the `if` block handles the error case).
  </action>
  <verify>
    <automated>cd /Users/nwessel/Claude\ Code/Business/Products/clawforge && grep -q 'PREFLIGHT' docker/job/entrypoint.sh && grep -q 'preflight.md' docker/job/entrypoint.sh && grep -q '\.claude/commands/gsd/' docker/job/entrypoint.sh && grep -q 'exit 1' docker/job/entrypoint.sh && echo "PASS" || echo "FAIL"</automated>
    <manual>Read through the entrypoint and confirm: (1) preflight block is between log dir setup and system prompt build, (2) GSD check exits 1 on failure, (3) preflight.md heredoc captures all required fields, (4) uses ${HOME} not /root/.</manual>
  </verify>
  <done>Entrypoint has preflight block that echoes HOME/claude/GSD/cwd to Actions log, exits non-zero if GSD is missing, and writes preflight.md to the job logs directory for inclusion in the PR.</done>
</task>

</tasks>

<verification>
1. `grep '.env.vps' .gitignore` returns a match
2. `docker/job/entrypoint.sh` contains `printf '%s' "${FULL_PROMPT}" | claude -p` (stdin pipe, not positional arg)
3. `docker/job/entrypoint.sh` contains preflight block with `=== PREFLIGHT ===` markers
4. `docker/job/entrypoint.sh` contains GSD runtime check with `exit 1` on failure
5. `docker/job/entrypoint.sh` writes `preflight.md` to `${LOG_DIR}`
6. `docker/job/entrypoint.sh` logs `FULL_PROMPT length` before claude invocation
7. No reference to `"${FULL_PROMPT}"` as a positional argument to `claude -p`
</verification>

<success_criteria>
- .env.vps is excluded from git tracking
- The claude -p invocation uses stdin pipe pattern (printf | claude -p)
- Prompt length is logged before invocation for future debugging
- Preflight block runs before system prompt build and writes preflight.md
- Missing GSD at runtime causes immediate job failure (exit 1)
- All changes are in docker/job/entrypoint.sh and .gitignore only
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-fix/01-01-SUMMARY.md`
</output>
