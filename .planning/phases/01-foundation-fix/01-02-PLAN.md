---
phase: 01-foundation-fix
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - docker/job/Dockerfile
  - templates/docker/job/Dockerfile
  - templates/docker/job/entrypoint.sh
autonomous: true
requirements:
  - FOUND-05
  - FOUND-03
  - FOUND-04

must_haves:
  truths:
    - "Docker build fails loudly if GSD install produces no /root/.claude/commands/gsd/ directory"
    - "templates/docker/job/Dockerfile is byte-for-byte equivalent to docker/job/Dockerfile"
    - "templates/docker/job/entrypoint.sh is byte-for-byte equivalent to docker/job/entrypoint.sh"
  artifacts:
    - path: "docker/job/Dockerfile"
      provides: "Build-time GSD verification"
      contains: "GSD install failed"
    - path: "templates/docker/job/Dockerfile"
      provides: "Synced template Dockerfile"
      contains: "get-shit-done-cc"
    - path: "templates/docker/job/entrypoint.sh"
      provides: "Synced template entrypoint"
      contains: "Task,Skill"
  key_links:
    - from: "docker/job/Dockerfile"
      to: "/root/.claude/commands/gsd/"
      via: "RUN test -d assertion"
      pattern: "test -d.*\\.claude/commands/gsd"
    - from: "templates/docker/job/Dockerfile"
      to: "docker/job/Dockerfile"
      via: "byte-for-byte sync"
      pattern: "N/A — validated by diff"
    - from: "templates/docker/job/entrypoint.sh"
      to: "docker/job/entrypoint.sh"
      via: "byte-for-byte sync"
      pattern: "N/A — validated by diff"
---

<objective>
Add build-time GSD verification to the Dockerfile and sync both template files to match their live counterparts.

Purpose: The live Dockerfile installs GSD but never verifies it succeeded — a silent failure means the image builds fine but jobs fail at runtime. The template files are stale: template Dockerfile is missing the GSD install step entirely, and template entrypoint.sh is missing Task,Skill from ALLOWED_TOOLS and all the fixes from Plan 01. This plan adds a build-time assertion and eliminates template drift.

Output: Updated `docker/job/Dockerfile` with build-time verification. `templates/docker/job/Dockerfile` and `templates/docker/job/entrypoint.sh` synced to match live versions exactly.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-fix/01-RESEARCH.md
@.planning/phases/01-foundation-fix/01-01-SUMMARY.md
@docker/job/Dockerfile
@docker/job/entrypoint.sh
@templates/docker/job/Dockerfile
@templates/docker/job/entrypoint.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add build-time GSD verification to Dockerfile</name>
  <files>docker/job/Dockerfile</files>
  <action>
**FOUND-05: Build-time verification in docker/job/Dockerfile**

The current Dockerfile has these lines (lines 37-38):
```dockerfile
# Install GSD skills for Claude Code
RUN npx get-shit-done-cc@latest --claude --global
```

Immediately after this RUN step (before `# Create workspace and config directories`), add a new RUN step that asserts GSD installed correctly:

```dockerfile
# Verify GSD installed successfully (fail build if missing)
RUN test -d /root/.claude/commands/gsd/ && \
    ls /root/.claude/commands/gsd/ | grep -q . || \
    (echo "ERROR: GSD install failed — /root/.claude/commands/gsd/ missing or empty" && exit 1)
```

This must be placed IMMEDIATELY after the GSD install RUN and BEFORE the `# Create workspace and config directories` line. No other RUN steps should be inserted between install and verification (per RESEARCH.md pitfall 5 — prevents layer caching from masking a vacuously-true check).

The resulting Dockerfile section should read:
```dockerfile
# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Install GSD skills for Claude Code
RUN npx get-shit-done-cc@latest --claude --global

# Verify GSD installed successfully (fail build if missing)
RUN test -d /root/.claude/commands/gsd/ && \
    ls /root/.claude/commands/gsd/ | grep -q . || \
    (echo "ERROR: GSD install failed — /root/.claude/commands/gsd/ missing or empty" && exit 1)

# Create workspace and config directories
RUN mkdir -p /workspace /workspace/.claude
```

Note: Using `/root/` here is correct for Dockerfile RUN context (there is no shell variable expansion of ${HOME} during build unless explicitly set). The entrypoint uses `${HOME}` for runtime flexibility, but the Dockerfile build context always runs as root.
  </action>
  <verify>
    <automated>cd /Users/nwessel/Claude\ Code/Business/Products/clawforge && grep -q 'GSD install failed' docker/job/Dockerfile && grep -q 'test -d /root/.claude/commands/gsd/' docker/job/Dockerfile && echo "PASS" || echo "FAIL"</automated>
    <manual>Read Dockerfile and confirm the verification RUN is immediately after the GSD install RUN and before workspace creation.</manual>
  </verify>
  <done>Docker build will fail with "ERROR: GSD install failed" if the GSD install step produces no files in /root/.claude/commands/gsd/. The verification is placed immediately after install with no intervening layers.</done>
</task>

<task type="auto">
  <name>Task 2: Sync template Dockerfile and entrypoint.sh to match live versions</name>
  <files>templates/docker/job/Dockerfile, templates/docker/job/entrypoint.sh</files>
  <action>
**FOUND-03: Sync templates/docker/job/Dockerfile**

Copy `docker/job/Dockerfile` (which now includes the GSD install + verification from Task 1) to `templates/docker/job/Dockerfile` as a byte-for-byte replacement. Do NOT manually edit the template — read the live file and write it verbatim to the template path.

The template Dockerfile is currently missing:
1. The GSD install step (`RUN npx get-shit-done-cc@latest --claude --global`)
2. The GSD verification step (added in Task 1)

After this operation, `diff docker/job/Dockerfile templates/docker/job/Dockerfile` must produce NO output.

**FOUND-04: Sync templates/docker/job/entrypoint.sh**

Copy `docker/job/entrypoint.sh` (which now includes all Plan 01 fixes: stdin pipe, preflight block, GSD runtime check, prompt length logging) to `templates/docker/job/entrypoint.sh` as a byte-for-byte replacement.

The template entrypoint.sh is currently missing:
1. `Task,Skill` in ALLOWED_TOOLS default (line 78)
2. Preflight diagnostic block (from Plan 01)
3. stdin pipe fix (from Plan 01)
4. FULL_PROMPT length logging (from Plan 01)

After this operation, `diff docker/job/entrypoint.sh templates/docker/job/entrypoint.sh` must produce NO output.

**Important:** Read the live files FIRST (they contain Plan 01 changes), then write them to the template paths. Do not attempt to manually reproduce the changes — copy verbatim to guarantee byte-for-byte equivalence.
  </action>
  <verify>
    <automated>cd /Users/nwessel/Claude\ Code/Business/Products/clawforge && diff docker/job/Dockerfile templates/docker/job/Dockerfile && diff docker/job/entrypoint.sh templates/docker/job/entrypoint.sh && echo "PASS" || echo "FAIL"</automated>
    <manual>Run diff between both file pairs. Zero output means byte-for-byte match. Verify template Dockerfile has GSD install + verification. Verify template entrypoint.sh has Task,Skill, preflight block, and stdin pipe.</manual>
  </verify>
  <done>templates/docker/job/Dockerfile is byte-for-byte identical to docker/job/Dockerfile (includes GSD install + verification). templates/docker/job/entrypoint.sh is byte-for-byte identical to docker/job/entrypoint.sh (includes all Plan 01 fixes). diff exits 0 for both pairs.</done>
</task>

</tasks>

<verification>
1. `docker/job/Dockerfile` contains GSD verification RUN step with "GSD install failed" error message
2. `diff docker/job/Dockerfile templates/docker/job/Dockerfile` produces no output (exit 0)
3. `diff docker/job/entrypoint.sh templates/docker/job/entrypoint.sh` produces no output (exit 0)
4. `templates/docker/job/Dockerfile` contains `get-shit-done-cc` (GSD install present)
5. `templates/docker/job/entrypoint.sh` contains `Task,Skill` in ALLOWED_TOOLS
6. `templates/docker/job/entrypoint.sh` contains `printf '%s'` stdin pipe pattern
</verification>

<success_criteria>
- Docker build fails loudly with descriptive error if GSD install produces empty or missing directory
- Template Dockerfile matches live Dockerfile exactly (diff exits 0)
- Template entrypoint.sh matches live entrypoint.sh exactly (diff exits 0)
- No template drift remains between docker/job/ and templates/docker/job/
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-fix/01-02-SUMMARY.md`
</output>
