---
phase: 07-previous-job-context
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - lib/ai/tools.js
autonomous: true
requirements: [HIST-02, HIST-03, HIST-04]

must_haves:
  truths:
    - "A follow-up job in the same thread includes a Prior Job Context section when the previous PR was merged"
    - "A follow-up job in the same thread does NOT include prior context when no merged outcome exists"
    - "A job in a thread with no prior jobs proceeds with the original description unchanged"
    - "A database error during prior context lookup does not prevent the job from being created"
  artifacts:
    - path: "lib/ai/tools.js"
      provides: "Prior context enrichment in createJobTool"
      contains: "getLastMergedJobOutcome"
  key_links:
    - from: "lib/ai/tools.js"
      to: "lib/db/job-outcomes.js"
      via: "import getLastMergedJobOutcome"
      pattern: "getLastMergedJobOutcome\\(threadId\\)"
    - from: "lib/ai/tools.js"
      to: "lib/tools/create-job.js"
      via: "createJob(enrichedDescription)"
      pattern: "createJob\\(enrichedDescription\\)"
---

<objective>
Enrich follow-up job descriptions with prior job context by looking up the most recent merged outcome for the same thread and prepending a summary section.

Purpose: When a user sends a follow-up message in the same thread, the new agent should know what the previous agent accomplished. This closes the continuity loop so agents pick up where the last one left off instead of rediscovering repo state.
Output: Modified `createJobTool` in `lib/ai/tools.js` that enriches job descriptions with prior merged job context.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-previous-job-context/07-RESEARCH.md
@.planning/phases/07-previous-job-context/07-01-SUMMARY.md
@lib/ai/tools.js
@lib/db/job-outcomes.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prior context lookup and injection to createJobTool</name>
  <files>lib/ai/tools.js</files>
  <action>
1. Add import at top of `lib/ai/tools.js`:
```javascript
import { getLastMergedJobOutcome } from '../db/job-outcomes.js';
```

2. Inside the `createJobTool` handler function, BEFORE the existing `const result = await createJob(job_description);` line, add the prior context enrichment logic:

```javascript
// Enrich job_description with prior job context if a merged outcome exists
let enrichedDescription = job_description;
if (threadId) {
  try {
    const prior = getLastMergedJobOutcome(threadId);
    if (prior) {
      const changedFiles = JSON.parse(prior.changedFiles || '[]');
      const priorContext = [
        '## Prior Job Context',
        '',
        `**Previous PR:** ${prior.prUrl || '(no URL)'}`,
        `**Status:** ${prior.status} (${prior.mergeResult})`,
        changedFiles.length ? `**Files changed:** ${changedFiles.join(', ')}` : '',
        prior.logSummary ? `**What happened:** ${prior.logSummary}` : '',
      ].filter(Boolean).join('\n');

      enrichedDescription = `${priorContext}\n\n---\n\n${job_description}`;
    }
  } catch (err) {
    console.error('Failed to load prior job context:', err);
    // Non-fatal — proceed with original description
  }
}
```

Key implementation notes:
- The `threadId` variable already exists from `const threadId = config?.configurable?.thread_id;` — use the same variable (it's already declared above).
- Note the existing code flow: `threadId` is extracted at line 26, then used AFTER `createJob` for `saveJobOrigin`. Move the `threadId` extraction to BEFORE the enrichment block (it already is, since it's at line 26).
- Replace `const result = await createJob(job_description);` with `const result = await createJob(enrichedDescription);` to pass the enriched description.
- No `mergeResult` check is needed in the caller — `getLastMergedJobOutcome` already filters for `mergeResult === 'merged'` at the query level (HIST-03).
- The try/catch ensures a DB error (e.g., table not migrated yet) does not block job creation.
- `JSON.parse(prior.changedFiles || '[]')` handles both empty string and valid JSON safely.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && grep -n "getLastMergedJobOutcome" lib/ai/tools.js && grep -n "enrichedDescription" lib/ai/tools.js && grep -n "Prior Job Context" lib/ai/tools.js</automated>
    <manual>Verify the createJob call uses enrichedDescription, and the prior context block is only added when getLastMergedJobOutcome returns a non-null result</manual>
  </verify>
  <done>createJobTool enriches follow-up job descriptions with prior merged job context. Lookup is scoped by thread_id (HIST-04), gated on merged status at query level (HIST-03), includes PR URL, status, changed files, and log summary (HIST-02), and fails gracefully on errors.</done>
</task>

</tasks>

<verification>
1. `lib/ai/tools.js` imports `getLastMergedJobOutcome` from `../db/job-outcomes.js`
2. The enrichment block runs BEFORE `createJob()` and ONLY when `threadId` is available
3. `createJob(enrichedDescription)` is called instead of `createJob(job_description)` when prior context exists
4. The prior context section includes: PR URL, status, merge result, changed files, log summary
5. Try/catch ensures lookup failure does not block job creation
6. No duplicate `threadId` extraction — reuses the existing variable
7. `saveJobOrigin` still runs after `createJob` (existing behavior preserved)
</verification>

<success_criteria>
- Follow-up job descriptions include "## Prior Job Context" section when merged outcome exists (HIST-02)
- No prior context added when no merged outcome exists for the thread (HIST-03)
- Lookup uses thread_id, not job_id (HIST-04)
- Job creation succeeds even if DB lookup fails
- Existing saveJobOrigin flow is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/07-previous-job-context/07-02-SUMMARY.md`
</output>
