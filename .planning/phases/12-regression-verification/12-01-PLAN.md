---
phase: 12-regression-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/12-regression-verification/VERIFICATION-RUNBOOK.md
autonomous: false
requirements:
  - REG-01
  - REG-02

must_haves:
  truths:
    - "A same-repo job on Noah/Archie completes and fires exactly one Slack/Telegram notification with a clawforge PR URL"
    - "A same-repo job on StrategyES/Epic completes and fires exactly one Slack notification (Jim-restricted)"
    - "A cross-repo job on Noah/Archie targets neurostory, creates a PR in ScalingEngine/neurostory, and notifies with the neurostory PR URL"
    - "Sending a job targeting a repo not in ALLOWED_REPOS is rejected by the agent before any job branch is created"
    - "GitHub Actions logs for all runs contain no PAT values in plain text (no ghp_ or github_pat_ tokens)"
    - "Notification wording distinguishes 'PR open for review' (cross-repo) from 'merged' (same-repo)"
  artifacts:
    - path: ".planning/phases/12-regression-verification/VERIFICATION-RUNBOOK.md"
      provides: "Step-by-step operator runbook for all 5 test scenarios"
      contains: "S1, S2, S3, S4, S5"
  key_links:
    - from: "Runbook S1"
      to: "entrypoint.sh same-repo guard"
      via: "Actions log check: WORK_DIR=/job"
      pattern: "Working directory: /job"
    - from: "Runbook S3"
      to: "ScalingEngine/neurostory PR"
      via: "gh pr list --repo ScalingEngine/neurostory"
      pattern: "clawforge/{UUID}"
    - from: "Runbook S4"
      to: "agent rejection response"
      via: "no job/* branch created"
      pattern: "no GitHub Actions run triggered"
---

<objective>
Write the VERIFICATION-RUNBOOK.md that operators execute to confirm v1.2 is working end-to-end on both instances with no regressions.

Purpose: This is the gate for the entire v1.2 release. No code is written in this phase — every change shipped in phases 9-11 is treated as complete and the goal is to confirm they work in production without silent failures.

Output: .planning/phases/12-regression-verification/VERIFICATION-RUNBOOK.md — a human-executable checklist covering 5 scenarios across both instances, with explicit boolean pass/fail criteria for every observable.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-regression-verification/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write VERIFICATION-RUNBOOK.md</name>
  <files>.planning/phases/12-regression-verification/VERIFICATION-RUNBOOK.md</files>
  <action>
Create `.planning/phases/12-regression-verification/VERIFICATION-RUNBOOK.md` covering all 5 scenarios below. Each scenario MUST follow this exact structure:

```
## S{N}: {Title}
**Instance:** {Noah/Archie | StrategyES/Epic}
**Job Type:** {same-repo | cross-repo | negative}
**Requirements Confirmed:** {REG-01 | REG-02 | both}

### Preconditions
- [list of what must be true before running]

### Trigger
- [exact action operator takes — message text, channel, user account]

### Observe
- [where to look and what to look for, with exact URLs or commands]

### Pass Criteria (ALL must be true)
- [ ] [boolean observable 1]
- [ ] [boolean observable 2]
...

### Fail Indicators
- [what failure looks like]

### Cleanup
- [branch/PR deletion steps]
```

**The 5 scenarios:**

**S1 — Noah/Archie Same-Repo (REG-01, REG-02)**
- Instance: Noah/Archie
- Trigger: Send any simple job to Noah/Archie via Slack or Telegram (e.g., "Create a job: add a comment to lib/paths.js saying 'verified by regression test'")
- Observe: GitHub Actions run-job.yml log; Slack/Telegram notification received
- Pass criteria:
  - Exactly one GitHub Actions run triggered on clawforge repo
  - Actions log shows "Working directory: /job" (NOT /workspace)
  - PR created on ScalingEngine/clawforge (NOT a foreign repo)
  - Exactly one Slack or Telegram notification received with a github.com/ScalingEngine/clawforge/pull/... URL
  - Notification message says "merged" or "completed" (same-repo language, not "PR open for review")
  - notify-pr-complete.yml shows route step output "path=same_repo" for workflow_run trigger AND "path=skip" for push trigger (no double-fire)
- Cleanup: Delete the job/* branch on clawforge; close/merge/delete the PR

**S2 — StrategyES/Epic Same-Repo (REG-02)**
- Instance: StrategyES/Epic
- PREREQUISITE: Confirm with operator that StrategyES REPOS.json content is final (STATE.md blocker)
- Trigger: Jim sends a simple job via Slack to StrategyES channel (operator must log in as Jim or have Jim run this)
- Send: "Create a job: add a comment to any file in strategyes-lab saying 'verified by regression test'"
- Observe: GitHub Actions run on strategyes-lab repo; Slack notification in StrategyES channel
- Pass criteria:
  - GitHub Actions run triggered on strategyes-lab repo (NOT clawforge)
  - PR created on ScalingEngine/strategyes-lab
  - Exactly one Slack notification received in StrategyES channel with a strategyes-lab PR URL
  - Message sent from Noah's account or non-Jim account receives NO response (user ID restriction active)
- Cleanup: Delete job/* branch; close/merge/delete PR

**S3 — Noah/Archie Cross-Repo to Neurostory (REG-02)**
- Instance: Noah/Archie
- PREREQUISITE: Confirm AGENT_GH_TOKEN on Noah/Archie has contents:write + pull_requests:write on ScalingEngine/neurostory (STATE.md blocker)
- Trigger: Send via Slack or Telegram: "Create a job targeting neurostory: add a comment to any file saying 'verified by cross-repo regression test'"
- Observe: GitHub Actions run on clawforge (run-job.yml); PR created on ScalingEngine/neurostory; Slack/Telegram notification
- Pass criteria:
  - target.json written to clawforge job branch alongside job.md
  - Actions log shows "Working directory: /workspace" (NOT /job)
  - PR created on ScalingEngine/neurostory with branch name matching clawforge/{UUID}
  - PR base branch matches neurostory's actual default branch (confirmed via `gh repo view ScalingEngine/neurostory --json defaultBranchRef`)
  - PR body contains ClawForge attribution and job ID
  - Slack/Telegram notification received with a github.com/ScalingEngine/neurostory/pull/... URL
  - Notification message says "PR open for review" (NOT "merged" — cross-repo semantic)
  - `GET /api/jobs/status?jobId={UUID}` (with API key) returns target_repo populated in JSON
  - notify-pr-complete.yml push trigger fires and routes to path=cross_repo
- Cleanup: Close the neurostory PR; delete clawforge/{UUID} branch on neurostory; delete job/* branch on clawforge

**S4 — Rejected Repo (REG-01, agent-layer)**
- Instance: Noah/Archie
- Trigger: Send via Slack or Telegram: "Create a job targeting repo: unknown-repo — add a hello world file"
- Observe: Agent response in channel; GitHub Actions (should NOT trigger)
- Pass criteria:
  - Agent responds with an error message listing available repo names (clawforge, neurostory)
  - NO GitHub Actions run is triggered on clawforge (no job/* branch created)
  - No target.json is written anywhere
- Fail indicators: Any GitHub Actions run triggered; agent silently ignores the target and runs against clawforge anyway

**S5 — PAT Log Scan (Passive, both instances)**
- Run during S1 and S3 (no separate trigger needed)
- Observe: Raw GitHub Actions log for run-job.yml on both instances
- Pass criteria:
  - Search log for "ghp_" — zero occurrences
  - Search log for "github_pat_" — zero occurrences
  - REPO_URL line in log shows https://github.com/... with no token embedded (gh auth setup-git path)
  - SECRETS/LLM_SECRETS env vars passed to docker show filtered JSON, no raw token values visible

**Document structure:**

Start with a header section:
```
# Regression Verification Runbook — v1.2 Cross-Repo Job Targeting

**Date:** [operator fills in]
**Operator:** [operator fills in]
**Status:** [ ] In Progress [ ] PASS [ ] FAIL

## Prerequisites

Before running any scenario:
1. Confirm AGENT_GH_TOKEN on Noah/Archie has contents:write + pull_requests:write on ScalingEngine/neurostory
2. Confirm StrategyES REPOS.json content is final with operator
3. Both instances must be running (docker ps confirms event handler containers)
4. GitHub Actions must be enabled on ScalingEngine/clawforge and ScalingEngine/strategyes-lab

## Scenario Summary

| Scenario | Instance | Type | Requirements | Status |
|----------|----------|------|--------------|--------|
| S1 | Noah/Archie | Same-repo | REG-01, REG-02 | [ ] |
| S2 | StrategyES/Epic | Same-repo | REG-02 | [ ] |
| S3 | Noah/Archie | Cross-repo | REG-02 | [ ] |
| S4 | Noah/Archie | Rejection | REG-01 | [ ] |
| S5 | Both | PAT scan (passive) | Success criteria 4 | [ ] |

## Pass Gate

v1.2 ships when ALL five scenarios are marked PASS.
```

Then the 5 scenario sections, then a results section:

```
## Results

| Scenario | Date | Operator | Pass/Fail | Notes |
|----------|------|----------|-----------|-------|
| S1 | | | | |
| S2 | | | | |
| S3 | | | | |
| S4 | | | | |
| S5 | | | | |

## Issues Found

[List any failures with enough detail to open a bug]
```
  </action>
  <verify>
    <automated>test -f "/Users/nwessel/Claude Code/Business/Products/clawforge/.planning/phases/12-regression-verification/VERIFICATION-RUNBOOK.md" && grep -c "## S[1-5]" "/Users/nwessel/Claude Code/Business/Products/clawforge/.planning/phases/12-regression-verification/VERIFICATION-RUNBOOK.md" | grep -q "^5$" && echo "PASS: runbook exists with 5 scenarios" || echo "FAIL: runbook missing or incomplete"</automated>
    <manual>Open VERIFICATION-RUNBOOK.md and confirm: (1) 5 scenario sections present, (2) each has Pass Criteria as checkboxes, (3) prerequisites section covers PAT scope and StrategyES REPOS.json blockers, (4) results table present at end</manual>
  </verify>
  <done>VERIFICATION-RUNBOOK.md exists with all 5 scenarios (S1-S5), each with preconditions, trigger, observe, boolean pass criteria, fail indicators, and cleanup. Prerequisites section covers known STATE.md blockers. Results table ready for operator sign-off.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify runbook completeness</name>
  <what-built>VERIFICATION-RUNBOOK.md with all 5 v1.2 regression scenarios</what-built>
  <how-to-verify>
    1. Open `.planning/phases/12-regression-verification/VERIFICATION-RUNBOOK.md`
    2. Confirm S1 (Noah same-repo) has the WORK_DIR=/job check and single-notification check
    3. Confirm S2 (StrategyES) has the Jim-restriction prerequisite documented
    4. Confirm S3 (cross-repo neurostory) has the PAT scope preflight and "PR open for review" language check
    5. Confirm S4 (rejection) checks that NO Actions run triggers
    6. Confirm S5 (PAT scan) instructs searching for ghp_ and github_pat_
    7. Confirm the pass gate is clear: all 5 PASS = v1.2 ships
  </how-to-verify>
  <action>Human reviews VERIFICATION-RUNBOOK.md for completeness per the how-to-verify checklist above.</action>
  <verify><automated>echo "checkpoint — human verification required"</automated></verify>
  <done>Operator confirms all 5 scenarios are correctly specified and runbook is ready for execution.</done>
  <resume-signal>Type "approved" to proceed with executing the runbook, or describe any issues with the runbook content</resume-signal>
</task>

</tasks>

<verification>
- VERIFICATION-RUNBOOK.md exists in .planning/phases/12-regression-verification/
- Contains exactly 5 scenario sections (S1-S5)
- Each scenario has boolean pass criteria (checkbox format)
- Prerequisites section covers both STATE.md blockers (PAT scope + StrategyES REPOS.json)
- Results table present for operator sign-off
- Pass gate is explicit: all 5 PASS required before v1.2 ships
</verification>

<success_criteria>
The runbook is complete and unambiguous: any operator can pick it up, run each scenario in order, mark pass/fail checkboxes, and know with certainty whether v1.2 is safe to ship. No judgment calls required — every pass criterion is boolean observable.
</success_criteria>

<output>
After completion, create `.planning/phases/12-regression-verification/12-01-SUMMARY.md`
</output>
