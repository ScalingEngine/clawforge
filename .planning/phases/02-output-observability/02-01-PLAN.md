---
phase: 02-output-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/job/hooks/gsd-invocations.js
  - docker/job/Dockerfile
  - docker/job/entrypoint.sh
  - templates/docker/job/hooks/gsd-invocations.js
  - templates/docker/job/Dockerfile
  - templates/docker/job/entrypoint.sh
autonomous: true
requirements: [OBSV-02]

must_haves:
  truths:
    - "Every job PR contains a gsd-invocations.jsonl file in logs/{jobId}/ (empty if no GSD calls)"
    - "Every job PR contains an observability.md summarizing GSD skill calls in human-readable markdown"
    - "The PostToolUse hook fires on Skill tool invocations and appends JSONL records"
    - "LOG_DIR is exported so child processes (claude and hooks) inherit it"
  artifacts:
    - path: "docker/job/hooks/gsd-invocations.js"
      provides: "PostToolUse hook that logs Skill invocations to gsd-invocations.jsonl"
      min_lines: 20
    - path: "docker/job/Dockerfile"
      provides: "Docker image with hook script and merged settings.json"
      contains: "gsd-invocations.js"
    - path: "docker/job/entrypoint.sh"
      provides: "Exported LOG_DIR and post-claude observability.md generation"
      contains: "export LOG_DIR"
    - path: "templates/docker/job/hooks/gsd-invocations.js"
      provides: "Template copy of hook script (byte-for-byte match)"
    - path: "templates/docker/job/Dockerfile"
      provides: "Template copy of Dockerfile (byte-for-byte match)"
    - path: "templates/docker/job/entrypoint.sh"
      provides: "Template copy of entrypoint (byte-for-byte match)"
  key_links:
    - from: "docker/job/Dockerfile"
      to: "/root/.claude/hooks/gsd-invocations.js"
      via: "COPY + RUN chmod in Dockerfile"
      pattern: "COPY hooks/gsd-invocations\\.js"
    - from: "docker/job/Dockerfile"
      to: "/root/.claude/settings.json"
      via: "RUN node -e merge step"
      pattern: "PostToolUse"
    - from: "docker/job/entrypoint.sh"
      to: "gsd-invocations.js hook"
      via: "export LOG_DIR inherited by claude subprocess"
      pattern: "export LOG_DIR"
    - from: "docker/job/entrypoint.sh"
      to: "observability.md"
      via: "jq parsing of gsd-invocations.jsonl after claude -p"
      pattern: "observability\\.md"
---

<objective>
Add PostToolUse hook for Skill invocation logging and post-claude observability.md generation, then sync all changes to templates.

Purpose: Make GSD usage visible in every job PR — operators can see which skills were invoked and how many times without digging through Actions logs.

Output: Hook script baked into Docker image, entrypoint generates observability.md, templates synced.
</objective>

<execution_context>
@/Users/nwessel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nwessel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-output-observability/02-RESEARCH.md
@.planning/phases/01-foundation-fix/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PostToolUse hook script, add to Dockerfile with settings merge, export LOG_DIR in entrypoint, add observability.md generation</name>
  <files>
    docker/job/hooks/gsd-invocations.js
    docker/job/Dockerfile
    docker/job/entrypoint.sh
  </files>
  <action>
**1. Create `docker/job/hooks/gsd-invocations.js`:**

Create the directory `docker/job/hooks/` and write the Node.js hook script. The script:
- Reads JSON from stdin (PostToolUse hook input)
- Checks `data.tool_name === 'Skill'` (capital S — confirmed from live transcript evidence in research)
- Reads `LOG_DIR` from `process.env.LOG_DIR`
- Exits silently (exit 0) if tool_name is not Skill or LOG_DIR is unset
- Writes one JSONL record per invocation to `${LOG_DIR}/gsd-invocations.jsonl` via `fs.appendFileSync`
- Record fields: `ts` (ISO timestamp), `tool_name`, `skill` (from `tool_input.skill`), `args` (truncated to 200 chars from `tool_input.args`), `cwd`
- Silent fail on all errors (try/catch with process.exit(0)) — never block tool execution
- Add shebang `#!/usr/bin/env node` at top

Use the exact code from the research "Complete Hook Script" section as the implementation.

**2. Modify `docker/job/Dockerfile`:**

After the existing GSD verification block (the `RUN test -d /root/.claude/commands/gsd/...` line), and BEFORE the `COPY entrypoint.sh` line, add:

```dockerfile
# Install PostToolUse hook for GSD invocation observability
RUN mkdir -p /root/.claude/hooks
COPY hooks/gsd-invocations.js /root/.claude/hooks/gsd-invocations.js
RUN chmod +x /root/.claude/hooks/gsd-invocations.js
# Merge hook settings into settings.json (preserves any existing GSD config)
RUN node -e "\
  const fs = require('fs'); \
  const settingsPath = '/root/.claude/settings.json'; \
  let existing = {}; \
  try { existing = JSON.parse(fs.readFileSync(settingsPath, 'utf8')); } catch(e) {} \
  existing.hooks = existing.hooks || {}; \
  existing.hooks.PostToolUse = existing.hooks.PostToolUse || []; \
  existing.hooks.PostToolUse.push({ \
    matcher: 'Skill', \
    hooks: [{ type: 'command', command: 'node /root/.claude/hooks/gsd-invocations.js' }] \
  }); \
  fs.writeFileSync(settingsPath, JSON.stringify(existing, null, 2)); \
"
```

IMPORTANT: Use the `node -e` merge approach (NOT a plain COPY) to avoid overwriting any settings.json that GSD's `npx get-shit-done-cc` may have written. This merges into existing settings safely.

**3. Modify `docker/job/entrypoint.sh`:**

Two changes:

(a) Change line 46 (`LOG_DIR="/job/logs/${JOB_ID}"`) to `export LOG_DIR="/job/logs/${JOB_ID}"`. The `export` is critical — without it, the claude subprocess and its hook child processes cannot read LOG_DIR.

(b) After the `claude -p` block (line 125, after `2>&1 | tee "${LOG_DIR}/claude-output.json" || true`), and BEFORE the `# 12. Commit all changes` block (line 127), insert a new section `# 12a. Generate observability.md from gsd-invocations.jsonl`:

```bash
# 12a. Generate observability.md from gsd-invocations.jsonl
JSONL_FILE="${LOG_DIR}/gsd-invocations.jsonl"
OBS_FILE="${LOG_DIR}/observability.md"

INVOCATION_COUNT=0
if [ -f "${JSONL_FILE}" ]; then
    INVOCATION_COUNT=$(wc -l < "${JSONL_FILE}" | tr -d ' ')
fi

{
  echo "# GSD Invocations — Job ${JOB_ID}"
  echo ""
  echo "**Job:** ${JOB_ID}"
  echo "**Generated:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
  echo "**Total invocations:** ${INVOCATION_COUNT}"
  echo ""

  if [ "${INVOCATION_COUNT}" -gt 0 ]; then
    echo "## Invocations"
    echo ""
    echo "| # | Skill | Arguments | Timestamp |"
    echo "|---|-------|-----------|-----------|"
    jq -r --slurp 'to_entries[] | "| \(.key + 1) | `\(.value.skill)` | \(.value.args | .[0:80]) | \(.value.ts) |"' "${JSONL_FILE}"
  else
    echo "_No GSD skills were invoked in this job._"
  fi
} > "${OBS_FILE}"
```

This must run AFTER claude -p (so the JSONL file exists) and BEFORE `git add -A` (so observability.md is committed).

Also: Ensure an empty JSONL file is touched before claude runs so it always exists in the PR even with zero invocations. Add `touch "${LOG_DIR}/gsd-invocations.jsonl"` right after the `mkdir -p "${LOG_DIR}"` line (after the new `export LOG_DIR` line).
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && test -f docker/job/hooks/gsd-invocations.js && grep -q 'tool_name.*Skill' docker/job/hooks/gsd-invocations.js && grep -q 'export LOG_DIR' docker/job/entrypoint.sh && grep -q 'observability.md' docker/job/entrypoint.sh && grep -q 'gsd-invocations.js' docker/job/Dockerfile && grep -q 'PostToolUse' docker/job/Dockerfile && echo "PASS" || echo "FAIL"</automated>
    <manual>Review that the Dockerfile merge step uses node -e (not COPY) to preserve existing settings.json content</manual>
  </verify>
  <done>
    - docker/job/hooks/gsd-invocations.js exists with Skill tool_name check and JSONL append
    - docker/job/Dockerfile has hook COPY, chmod, and settings.json merge RUN step after GSD verification
    - docker/job/entrypoint.sh exports LOG_DIR, touches empty JSONL, generates observability.md after claude -p
  </done>
</task>

<task type="auto">
  <name>Task 2: Sync templates to match live docker/job/ files</name>
  <files>
    templates/docker/job/hooks/gsd-invocations.js
    templates/docker/job/Dockerfile
    templates/docker/job/entrypoint.sh
  </files>
  <action>
Byte-for-byte copy all three live files to their template counterparts (per established pattern from Phase 1, Plan 02):

1. Create `templates/docker/job/hooks/` directory
2. Copy `docker/job/hooks/gsd-invocations.js` to `templates/docker/job/hooks/gsd-invocations.js`
3. Copy `docker/job/Dockerfile` to `templates/docker/job/Dockerfile`
4. Copy `docker/job/entrypoint.sh` to `templates/docker/job/entrypoint.sh`

Use byte-for-byte copy (the cp command or Write tool with identical content). Do NOT manually recreate — this guarantees zero drift.
  </action>
  <verify>
    <automated>cd "/Users/nwessel/Claude Code/Business/Products/clawforge" && diff docker/job/Dockerfile templates/docker/job/Dockerfile && diff docker/job/entrypoint.sh templates/docker/job/entrypoint.sh && diff docker/job/hooks/gsd-invocations.js templates/docker/job/hooks/gsd-invocations.js && echo "PASS: zero drift" || echo "FAIL: template drift detected"</automated>
  </verify>
  <done>
    - templates/docker/job/hooks/gsd-invocations.js is byte-for-byte identical to docker/job/hooks/gsd-invocations.js
    - templates/docker/job/Dockerfile is byte-for-byte identical to docker/job/Dockerfile
    - templates/docker/job/entrypoint.sh is byte-for-byte identical to docker/job/entrypoint.sh
  </done>
</task>

</tasks>

<verification>
1. `docker/job/hooks/gsd-invocations.js` exists, is executable (shebang), checks for `tool_name === 'Skill'`, reads `process.env.LOG_DIR`, writes JSONL via appendFileSync
2. `docker/job/Dockerfile` installs hook after GSD verification, merges settings.json via `node -e` (does not overwrite)
3. `docker/job/entrypoint.sh` has `export LOG_DIR`, touches empty JSONL, generates observability.md from JSONL after claude -p and before git add
4. All three template files are byte-for-byte identical to their live counterparts
5. No existing functionality broken (preflight, stdin pipe, GSD verification all preserved)
</verification>

<success_criteria>
- Hook script correctly filters for Skill tool_name and appends JSONL records
- Dockerfile merges hook settings without overwriting existing GSD config
- Entrypoint exports LOG_DIR, creates empty JSONL baseline, generates observability.md after claude execution
- Templates have zero drift from live files
</success_criteria>

<output>
After completion, create `.planning/phases/02-output-observability/02-01-SUMMARY.md`
</output>
