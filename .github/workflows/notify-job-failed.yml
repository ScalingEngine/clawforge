name: Notify Job Failed

on:
  workflow_run:
    workflows: ["Run ClawForge Job"]
    types: [completed]

jobs:
  notify-failure:
    runs-on: ${{ vars.RUNS_ON || 'ubuntu-latest' }}
    if: >
      github.event.workflow_run.conclusion != 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'job/')
    permissions:
      contents: read

    steps:
      - name: Checkout job branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Send failure notification
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          JOB_ID="${BRANCH#job/}"
          RUN_ID="${{ github.event.workflow_run.id }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${RUN_ID}"

          # Read job.md (exists on branch from job creation)
          JOB_CONTENT=""
          if [ -f "logs/${JOB_ID}/job.md" ]; then
            JOB_CONTENT=$(cat "logs/${JOB_ID}/job.md")
          fi

          # Read claude-output.jsonl if it was committed (more useful than full Actions log)
          CLAUDE_OUTPUT=""
          if [ -f "logs/${JOB_ID}/claude-output.jsonl" ]; then
            CLAUDE_OUTPUT=$(head -c 4000 "logs/${JOB_ID}/claude-output.jsonl")
          fi

          # Detect failure stage from committed artifacts
          # preflight.md exists → docker pulled, auth completed
          # claude-output.jsonl non-empty → Claude at least started
          FAILURE_STAGE="docker_pull"
          if [ -f "logs/${JOB_ID}/preflight.md" ]; then
            FAILURE_STAGE="auth"
          fi
          if [ -f "logs/${JOB_ID}/claude-output.jsonl" ] && [ -s "logs/${JOB_ID}/claude-output.jsonl" ]; then
            FAILURE_STAGE="claude"
          fi

          # Fetch the GitHub Actions run log as fallback (truncate to last 2000 chars)
          RUN_LOG=""
          if [ -z "$CLAUDE_OUTPUT" ]; then
            RUN_LOG=$(gh run view "$RUN_ID" --repo "${{ github.repository }}" --log 2>/dev/null | tail -c 2000 || echo "")
          fi

          # Combine: prefer claude output, fall back to run log
          LOG_CONTENT="${CLAUDE_OUTPUT:-$RUN_LOG}"

          STATUS="${{ github.event.workflow_run.conclusion }}"

          jq -n \
            --arg job_id "$JOB_ID" \
            --arg branch "$BRANCH" \
            --arg status "$STATUS" \
            --arg failure_stage "$FAILURE_STAGE" \
            --arg job "$JOB_CONTENT" \
            --arg run_url "$RUN_URL" \
            --arg log "$LOG_CONTENT" \
            '{
              job_id: $job_id,
              branch: $branch,
              status: $status,
              failure_stage: $failure_stage,
              job: $job,
              run_url: $run_url,
              pr_url: "",
              changed_files: [],
              commit_message: "",
              log: $log,
              merge_result: ""
            }' > /tmp/payload.json

          curl -s -X POST "${{ vars.APP_URL }}/api/github/webhook" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Webhook-Secret-Token: ${{ secrets.GH_WEBHOOK_SECRET }}" \
            -d @/tmp/payload.json
