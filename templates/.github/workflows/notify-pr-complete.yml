name: Notify Event Handler

on:
  workflow_run:
    workflows: ["Auto-Merge ClawForge PR"]
    types: [completed]
  push:
    branches:
      - 'job/**'

jobs:
  notify:
    runs-on: ${{ vars.RUNS_ON || 'ubuntu-latest' }}
    if: startsWith(github.event.workflow_run.head_branch, 'job/') || startsWith(github.ref_name, 'job/')
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'push' && github.sha || github.event.workflow_run.head_sha }}

      - name: Detect trigger path
        id: route
        run: |
          EVENT="${{ github.event_name }}"

          if [ "$EVENT" = "push" ]; then
            # Cross-repo path: check for pr-result.json on this job branch
            BRANCH="${{ github.ref_name }}"
            JOB_ID="${BRANCH#job/}"

            if [ -f "logs/${JOB_ID}/pr-result.json" ]; then
              PR_URL=$(jq -r '.pr_url' "logs/${JOB_ID}/pr-result.json")
              TARGET_REPO=$(jq -r '.target_repo' "logs/${JOB_ID}/pr-result.json")
              PR_NUMBER=$(jq -r '.pr_number' "logs/${JOB_ID}/pr-result.json")
              echo "path=cross_repo" >> "$GITHUB_OUTPUT"
              echo "pr_url=${PR_URL}" >> "$GITHUB_OUTPUT"
              echo "target_repo=${TARGET_REPO}" >> "$GITHUB_OUTPUT"
              echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
              echo "job_id=${JOB_ID}" >> "$GITHUB_OUTPUT"
              echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
              echo "Cross-repo PR detected: ${PR_URL}"
            else
              # Push without pr-result.json (e.g., initial job.md commit) — skip silently
              echo "path=skip" >> "$GITHUB_OUTPUT"
              echo "No pr-result.json found on ${BRANCH} — skipping notification"
            fi
          else
            # Same-repo path (workflow_run from auto-merge)
            echo "path=same_repo" >> "$GITHUB_OUTPUT"
          fi

      - name: Get PR number
        id: pr
        if: steps.route.outputs.path == 'same_repo'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"

          # Try workflow_run.pull_requests first
          PR_NUMBER=$(echo '${{ toJson(github.event.workflow_run.pull_requests) }}' | jq -r '.[0].number // empty')

          # Fallback: look up PR by head branch
          if [ -z "$PR_NUMBER" ]; then
            PR_NUMBER=$(gh pr list --head "$BRANCH" --state all --repo "${{ github.repository }}" --json number -q '.[0].number')
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found for branch $BRANCH"
            exit 1
          fi

          PR_URL=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json url -q '.url')

          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "url=$PR_URL" >> "$GITHUB_OUTPUT"
          echo "Found PR #$PR_NUMBER"

      - name: Gather job results and notify
        if: steps.route.outputs.path == 'same_repo'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          JOB_ID="${BRANCH#job/}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"

          # Check actual PR merge state
          PR_MERGED=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json mergedAt -q '.mergedAt')
          if [ -n "$PR_MERGED" ] && [ "$PR_MERGED" != "null" ]; then
            MERGE_RESULT="merged"
          else
            MERGE_RESULT="not_merged"
          fi

          # 1. Read job.md (on disk after checkout)
          JOB_CONTENT=""
          if [ -f "logs/${JOB_ID}/job.md" ]; then
            JOB_CONTENT=$(cat "logs/${JOB_ID}/job.md")
          fi

          # 2. Get last commit message via gh CLI
          COMMIT_MSG=$(gh pr view "$PR_NUMBER" --json commits --jq '.commits[-1].messageHeadline' --repo "${{ github.repository }}" 2>/dev/null || echo "")

          # 3. Get changed files (names only)
          CHANGED_FILES=$(gh pr diff "$PR_NUMBER" --name-only --repo "${{ github.repository }}" 2>/dev/null || echo "")

          # 4. Get PR status
          PR_STATUS=$(gh pr view "$PR_NUMBER" --json state --jq '.state' --repo "${{ github.repository }}" 2>/dev/null || echo "open")

          # 5. Read GSD invocation log (gsd-invocations.jsonl written by PostToolUse hook in job container)
          # The hook (docker/job/hooks/gsd-invocations.js) appends one JSONL record per Skill tool invocation.
          # This search finds it and sends the content in the notification payload's "log" field.
          LOG_CONTENT=""
          LOG_DIR="logs/${JOB_ID}"
          if [ -d "$LOG_DIR" ]; then
            LOG_FILE=$(find "$LOG_DIR" -name "gsd-invocations.jsonl" -type f | head -1)
            if [ -n "$LOG_FILE" ]; then
              LOG_CONTENT=$(cat "$LOG_FILE")
            fi
          fi

          # Determine status based on merge result and PR state
          if [ "$MERGE_RESULT" = "merged" ]; then
            STATUS="completed"
          else
            STATUS="$PR_STATUS"
          fi

          # 6. Build flat JSON payload
          jq -n \
            --arg job_id "$JOB_ID" \
            --arg branch "$BRANCH" \
            --arg status "$STATUS" \
            --arg job "$JOB_CONTENT" \
            --arg run_url "$RUN_URL" \
            --arg pr_url "${{ steps.pr.outputs.url }}" \
            --arg commit_message "$COMMIT_MSG" \
            --arg changed_files "$CHANGED_FILES" \
            --arg log "$LOG_CONTENT" \
            --arg merge_result "$MERGE_RESULT" \
            '{
              job_id: $job_id,
              branch: $branch,
              status: $status,
              job: $job,
              run_url: $run_url,
              pr_url: $pr_url,
              changed_files: ($changed_files | split("\n") | map(select(length > 0))),
              commit_message: $commit_message,
              log: $log,
              merge_result: $merge_result
            }' > "${RUNNER_TEMP:-/tmp}/payload.json"

          # 7. Send to event handler
          curl -s -X POST "${{ vars.APP_URL }}/api/github/webhook" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Webhook-Secret-Token: ${{ secrets.GH_WEBHOOK_SECRET }}" \
            -d @"${RUNNER_TEMP:-/tmp}/payload.json"

      - name: Notify cross-repo PR complete
        if: steps.route.outputs.path == 'cross_repo'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          JOB_ID="${{ steps.route.outputs.job_id }}"
          BRANCH="${{ steps.route.outputs.branch }}"
          PR_URL="${{ steps.route.outputs.pr_url }}"
          TARGET_REPO="${{ steps.route.outputs.target_repo }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Read job description from checked-out branch
          JOB_CONTENT=""
          if [ -f "logs/${JOB_ID}/job.md" ]; then
            JOB_CONTENT=$(cat "logs/${JOB_ID}/job.md")
          fi

          # Read GSD invocation log
          LOG_CONTENT=""
          LOG_DIR="logs/${JOB_ID}"
          if [ -d "$LOG_DIR" ]; then
            LOG_FILE=$(find "$LOG_DIR" -name "gsd-invocations.jsonl" -type f | head -1)
            if [ -n "$LOG_FILE" ]; then
              LOG_CONTENT=$(cat "$LOG_FILE")
            fi
          fi

          # Build cross-repo notification payload
          jq -n \
            --arg job_id "$JOB_ID" \
            --arg branch "$BRANCH" \
            --arg status "cross_repo_pr_open" \
            --arg job "$JOB_CONTENT" \
            --arg run_url "$RUN_URL" \
            --arg pr_url "$PR_URL" \
            --arg target_repo "$TARGET_REPO" \
            --arg log "$LOG_CONTENT" \
            --arg merge_result "cross_repo_pr_open" \
            '{
              job_id: $job_id,
              branch: $branch,
              status: $status,
              job: $job,
              run_url: $run_url,
              pr_url: $pr_url,
              target_repo: $target_repo,
              changed_files: [],
              commit_message: "",
              log: $log,
              merge_result: $merge_result
            }' > "${RUNNER_TEMP:-/tmp}/payload.json"

          # Send to event handler
          curl -s -X POST "${{ vars.APP_URL }}/api/github/webhook" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Webhook-Secret-Token: ${{ secrets.GH_WEBHOOK_SECRET }}" \
            -d @"${RUNNER_TEMP:-/tmp}/payload.json"
